<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Betongytor â€” Material- & Kostnadsestimator PRO</title>
  <style>
    /* ================== THEME ================== */
    :root{
      --bg:#f4f9ff;
      --fg:#0f172a;
      --muted:#475569;
      --panel:#ffffff;
      --line:#dbe5f0;
      --accent:#2563eb;
      --accent-2:#10b981;
      --danger:#ef4444;
      --shadow:0 10px 24px rgba(2,32,71,.08);
      --rowBg:#ffffff;
      --rowAlt:#f8fbff;
      --rowProd:#f0fbf5;
      --rowProj:#f4f8ff;
      --tooltipBg:#111827;
      --tooltipFg:#f9fafb;
      --grad:linear-gradient(180deg,#f8fbff 0%,#eef6ff 50%,#f7fffb 100%);
    }
    body.dark-mode{
      --bg:#0b0f1a;
      --fg:#e5efff;
      --muted:#9fb0c8;
      --panel:#0f172a;
      --line:#213047;
      --accent:#60a5fa;
      --accent-2:#34d399;
      --danger:#f87171;
      --shadow:0 10px 24px rgba(0,0,0,.45);
      --rowBg:#0b1427;
      --rowAlt:#0c1a33;
      --rowProd:#0b1e19;
      --rowProj:#0b1424;
      --tooltipBg:#0b1220;
      --tooltipFg:#e5efff;
      --grad:linear-gradient(180deg,#0b0f1a 0%,#0b1220 100%);
    }
    html,body{height:100%}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,sans-serif;
      background:var(--grad); color:var(--fg); margin:0;
      padding-bottom:90px;
    }

    /* ================== TOP BARS ================== */
    .toolbar{
      position:sticky;top:0;z-index:30;
      background:linear-gradient(180deg,var(--panel) 0%,rgba(255,255,255,.65) 100%);
      backdrop-filter:saturate(1.15) blur(6px);
      padding:10px 12px; display:flex; flex-wrap:wrap; gap:10px; align-items:center;
      border-bottom:1px solid var(--line); box-shadow:0 6px 14px rgba(15,23,42,.06);
    }
    body.dark-mode .toolbar{
      background:linear-gradient(180deg,#0f172a 0%,#0b1220 100%);
      box-shadow:0 6px 14px rgba(0,0,0,.45);
    }
    .subbar{
      position:sticky;top:60px;z-index:29;
      background:linear-gradient(180deg,var(--panel) 0%,rgba(255,255,255,.9) 100%);
      padding:8px 12px; border-bottom:1px solid var(--line);
      display:flex; align-items:center;
    }
    body.dark-mode .subbar{
      background:linear-gradient(180deg,#0f172a 0%,#0b1220 100%);
    }
    .subbar .left{flex:1; display:flex; gap:8px; align-items:center}
    .subbar .right{display:flex; gap:8px; align-items:center}

    .group{display:flex;align-items:center;gap:8px;background:var(--panel);border:1px solid var(--line);padding:6px 8px;border-radius:12px}
    .btn{
      appearance:none;border:0;border-radius:12px;padding:8px 12px;cursor:pointer;font-weight:700;letter-spacing:.2px;
      box-shadow:var(--shadow);transition:transform .04s ease,filter .14s ease, background .2s ease, color .2s ease;
      background:var(--panel); color:var(--fg); border:1px solid var(--line);
    }
    .btn:active{transform:translateY(1px)}
    .btn-primary{background:var(--accent-2);color:#00140c;border:1px solid transparent}
    .btn-blue{background:var(--accent);color:#ecfeff;border:1px solid transparent}
    .icon-btn{width:42px;height:42px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px}
    .flag-btn{font-size:18px;line-height:1;padding:6px 10px;border-radius:10px;border:1px solid var(--line);background:var(--panel);cursor:pointer}
    .flag-btn.active{outline:2px solid var(--accent);}

    .grow{flex:1}
    .toolbar label{font-weight:600}
    .toolbar input[type="number"]{width:74px}

    /* Top "Add area" dock */
    #topAddDock{padding:10px 12px; display:flex; justify-content:flex-start}
    #btnAddAreaDock{min-width:220px}

    /* ================== LAYOUT ================== */
    #areasContainer{padding:12px}
    .area{
      background:var(--panel);border:1px solid var(--line);border-radius:16px;margin:16px 6px;padding:12px 12px 10px;
      box-shadow:var(--shadow); position:relative;
    }
    .area-header{
      display:grid;
      grid-template-columns: 260px 180px 120px 200px 1fr 180px auto;
      gap:10px; align-items:center; margin-bottom:6px
    }
    .mini-caption{grid-column:1/-1; font-size:.75em; color:var(--muted); margin-top:-2px;}
    .unit-wrap{display:flex;align-items:center;gap:6px}
    .unit-wrap input{flex:1;padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:var(--panel);color:var(--fg)}
    .unit-wrap .unit{font-weight:700;color:var(--muted)}
    .del-area{background:var(--panel);color:#991b1b;border:1px solid #fecaca55;border-radius:10px;padding:8px 10px;cursor:pointer}
    .del-area:hover{background:#ffeff157}

    /* Small illustration top-right (50% smaller) */
    .mini-illustration{border:1px solid var(--line);background:var(--panel);border-radius:12px;padding:6px;width:170px;justify-self:end}
    .mini-illustration canvas{width:100%;height:80px;border-radius:8px;background:var(--panel)}

    /* ================== TABLE ================== */
    table.area-table{width:100%;border-collapse:separate;border-spacing:0 5px;margin-bottom:4px}
    thead tr th{font-size:.72em;text-transform:uppercase;letter-spacing:.04em;color:var(--muted);padding:3px 6px}
    table.area-table th,table.area-table td{padding:3px 6px;background:var(--rowBg);border:1px solid var(--line)}
    table.area-table th:first-child,table.area-table td:first-child{border-top-left-radius:9px;border-bottom-left-radius:9px}
    table.area-table th:last-child,table.area-table td:last-child{border-top-right-radius:9px;border-bottom-right-radius:9px}
    table.area-table input,table.area-table select{
      width:100%;box-sizing:border-box;padding:3px 6px;border:1px solid var(--line);border-radius:8px;font:inherit;background:var(--panel);color:var(--fg);
      height:26px; line-height:24px
    }
    .th-group{background:var(--rowAlt);font-weight:800;text-align:center;border:1px solid var(--line);padding:3px 4px}
    .td-prod{background:var(--rowProd)}
    .td-proj{background:var(--rowProj)}
    .drag-handle{cursor:grab;font-size:16px;user-select:none}
    .product-row{position:relative;background:var(--rowBg)}
    .product-row.dragging{opacity:.6}

    /* overlay actions ONLY on hover */
    .row-actions-overlay{position:absolute; top:-9px; right:6px; display:none; gap:6px; z-index:3}
    .product-row:hover .row-actions-overlay{display:flex}
    .mini{font-size:.76em;padding:3px 6px;border-radius:7px;border:1px solid var(--line);background:var(--panel);cursor:pointer; height:22px}
    .mini.ghost{border-color:var(--line);color:var(--muted)}
    .mini.warn{border-color:#fde68a55;background:#fde68a19;color:#92400e}
    .mini.danger{border-color:#fecaca55;background:#fecaca22;color:#9f1239}

    /* Inline surface info under table - small text row */
    .surface-inline{display:none; margin:6px 2px 0; font-size:.92em; color:var(--muted)}
    .surface-inline.show{display:block}

    /* Footer buttons in area (stacked, same vertical line & size; smaller buttons) */
    .footer-buttons{display:flex; flex-direction:column; gap:6px; margin-top:6px}
    .btn-slim{padding:7px 10px; border-radius:10px; width:100%}

    /* ================== SUMMARY & INFO ================== */
    #infoSummary{margin:14px;background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow)}
    #infoSummary header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--line);padding:10px 12px}
    #infoSummary .body{padding:10px 12px}
    .info-card{border:1px solid var(--line);border-radius:12px;padding:10px;margin:8px 0;background:var(--rowAlt)}
    .product-total{border:1px solid var(--line);border-radius:12px;padding:10px;margin:8px 0;background:var(--rowAlt)}
    .product-total h5{margin:0 0 4px 0}
    .product-total .dim{color:var(--muted)}

    /* ================== STICKY FOOTER TOTAL ================== */
    #footerBar{
      position:fixed; left:0; right:0; bottom:0; z-index:40;
      background:linear-gradient(180deg,var(--panel) 0%, rgba(255,255,255,0.92) 100%);
      border-top:1px solid var(--line); display:flex; align-items:center; gap:10px; padding:10px 12px;
      box-shadow:0 -8px 20px rgba(0,0,0,.07)
    }
    body.dark-mode #footerBar{
      background:linear-gradient(180deg,#0f172a 0%, #0b1220 100%);
      box-shadow:0 -8px 20px rgba(0,0,0,.45)
    }
    #footerBar strong{font-size:1.05em}
    #footerBar .sp{flex:1}
    #footerBar .btn{padding:8px 12px;border-radius:10px}

    /* ================== TOAST & HOVERTIP ================== */
    #infoToast{
      position:fixed;right:16px;bottom:86px;background:var(--tooltipBg);color:var(--tooltipFg);padding:10px 12px;border-radius:999px;
      cursor:pointer;display:none;align-items:center;gap:8px;box-shadow:var(--shadow);z-index:45
    }
    #infoToast .dot{width:8px;height:8px;border-radius:50%;background:#22c55e}
    #hoverTip{
      position:fixed; pointer-events:none; z-index:50; display:none; max-width:320px;
      background:var(--tooltipBg); color:var(--tooltipFg); padding:8px 10px; border-radius:10px; font-size:.9em; box-shadow:var(--shadow)
    }

    /* ================== LOGS ================== */
    #logPanel{position:fixed;bottom:50px;left:0;right:0;background:#0b1220;color:#e5e7eb;font-family:ui-monospace,Consolas,monospace;font-size:.9em;max-height:230px;display:flex;flex-direction:column;border-top:2px solid #1f2937;z-index:35}
    body:not(.dark-mode) #logPanel{background:#0b1220}
    #logHeader{background:#0f172a;padding:6px 8px;font-weight:800;display:flex;align-items:center;gap:8px}
    #logHeader .sp{flex:1}
    #logHeader button{background:#1f2937;color:#fff;border:none;padding:4px 8px;margin-left:5px;cursor:pointer;font-weight:bold;border-radius:8px}
    #logContent{overflow-y:auto;padding:6px}
    #logPanel.minimized{max-height:none;height:auto}
    #logPanel.minimized #logContent{display:none}
    #logPanel.maximized{max-height:65vh}

    /* ================== PRINT ================== */
    @media print{
      .toolbar,.subbar,#topAddDock,#footerBar,#logPanel,#infoToast,#hoverTip{display:none!important}
      .area{border:none;margin:0;page-break-inside:avoid}
      .del-area,.row-actions-overlay,.drag-handle{display:none!important}
    }
  </style>
</head>
<body>
  <!-- ================== MAIN TOOLBAR ================== -->
  <div class="toolbar" id="toolbar">
    <!-- Undo/Redo then Dark/Step -->
    <button id="undo" class="btn icon-btn" disabled title="Ã…ngra"><span aria-hidden="true">â†¶</span></button>
    <button id="redo" class="btn icon-btn" disabled title="GÃ¶r om"><span aria-hidden="true">â†·</span></button>
    <div class="group">
      <label for="darkModeToggle" data-i18n="dark">MÃ¶rkt lÃ¤ge</label><input type="checkbox" id="darkModeToggle"/>
      <label for="stepModeToggle" data-i18n="step">Steg-fÃ¶r-steg</label><input type="checkbox" id="stepModeToggle"/>
    </div>

    <div class="group">
      <span data-i18n="vat">Moms</span>
      <label for="vatToggle" data-i18n="include">inkludera</label><input type="checkbox" id="vatToggle"/>
      <input type="number" id="vatPercent" value="25" step="1"/>%
    </div>

    <div class="group">
      <span data-i18n="overage">Spill</span>
      <label for="overageToggle" data-i18n="apply">anvÃ¤nd</label><input type="checkbox" id="overageToggle"/>
      <input type="number" id="overagePercent" value="10" step="1"/>%
    </div>

    <div class="group">
      <label for="exactToggle" data-i18n="exact">Exakt berÃ¤kning (ingen avrundning)</label>
      <input type="checkbox" id="exactToggle"/>
    </div>

    <div class="grow"></div>

    <!-- Language FAR RIGHT -->
    <div class="group">
      <strong data-i18n="language">SprÃ¥k</strong>
      <button id="langSV" class="flag-btn active" title="Svenska">ðŸ‡¸ðŸ‡ª</button>
      <button id="langEN" class="flag-btn" title="English">ðŸ‡¬ðŸ‡§</button>
    </div>
  </div>

  <!-- ================== SUBBAR (Import left, Export right) ================== -->
  <div class="subbar" id="subbar">
    <div class="left">
      <button id="importData" class="btn" data-i18n="import">Importera</button>
      <input type="file" id="fileInput" accept=".json,.csv,.xls,.xlsx" style="display:none"/>
    </div>
    <div class="right">
      <button id="exportJSON" class="btn" data-i18n="exportJSON">Export JSON</button>
      <button id="exportCSV" class="btn" data-i18n="exportCSV">Export CSV</button>
      <button id="exportExcel" class="btn" data-i18n="exportExcel">Export Excel</button>
      <button id="printBtn" class="btn" data-i18n="print">Skriv ut / PDF</button>
    </div>
  </div>

  <!-- ================== ADD AREA DOCK (top; hidden after first area) ================== -->
  <div id="topAddDock">
    <button id="btnAddAreaDock" class="btn btn-primary" data-i18n="addArea">+ LÃ¤gg till omrÃ¥de</button>
  </div>

  <!-- ================== AREAS ================== -->
  <div id="areasContainer"></div>

  <!-- ================== SUMMARY & INFO ================== -->
  <section id="infoSummary" style="margin-top:8px">
    <header>
      <strong data-i18n="infoTitle">Info & summeringar</strong>
      <small id="lastInfoTime" style="color:var(--muted)"></small>
    </header>
    <div class="body" id="infoBody">
      <div class="info-card" id="moistureCard">
        <strong>Fukt & fuktighet</strong>
        <p style="margin:.4em 0 .2em 0; color:var(--muted)">
          HÃ¶g fukthalt i underlag/luft kan Ã¶ka Ã¥tgÃ¥ngen (absorptionsfÃ¶rluster) och fÃ¶rlÃ¤nga torktider. Rekommendation:
          torr och dammfri yta, RF â‰¤ 75â€“80% nÃ¤r datablad krÃ¤ver det, provyta vid tveksamhet. 
          <em>(Informativt â€” pÃ¥verkar inte berÃ¤kning automatiskt.)</em>
        </p>
      </div>
      <em data-i18n="infoEmpty">Ingen info Ã¤nnu. LÃ¤gg till produkter och ytor.</em>
    </div>
  </section>

  <!-- ================== GLOBAL TEMPLATES (bottom) ================== -->
  <section id="globalProducts" style="margin:14px;background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow)">
    <header style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--line);padding:10px 12px">
      <strong data-i18n="templatesTitle">Globala Produktmallar</strong>
      <div class="template-actions" style="display:flex;gap:8px">
        <button id="addTemplate" class="btn btn-primary" data-i18n="addTemplate">+ LÃ¤gg till mall</button>
        <button id="applyAllTemplates" class="btn" data-i18n="applyAllTemplates">AnvÃ¤nd ALLA pÃ¥ ALLA omrÃ¥den</button>
      </div>
    </header>
    <div class="body" id="templatesBody" style="padding:10px 12px"></div>
  </section>

  <!-- ================== STICKY FOOTER TOTAL ================== -->
  <div id="footerBar">
    <strong id="footerTotalLabel">Projektets totalsumma (exkl. moms):</strong>
    <strong id="footerTotalValue">0.00</strong>
    <span class="sp"></span>
    <button class="btn" id="btnScrollSummary">Visa summering</button>
  </div>

  <!-- ================== TOAST & HOVERTIP ================== -->
  <div id="infoToast" title="Visa info"><span class="dot"></span><span data-i18n="toast">Info uppdaterad â€” Visa</span></div>
  <div id="hoverTip"></div>

  <!-- ================== LOGS ================== -->
  <div id="logPanel" class="minimized">
    <div id="logHeader">LOGGAR<span class="sp"></span>
      <button id="minimizeLog">_</button><button id="maximizeLog">&#9723;</button>
    </div>
    <div id="logContent"></div>
  </div>

  <script>
  (()=>{"use strict";

    /* ================== I18N ================== */
    const i18n = {
      sv:{ addArea:"+ LÃ¤gg till omrÃ¥de", addAreaBelow:"+ LÃ¤gg till omrÃ¥de under",
        undoText:"Ã…ngra", redoText:"GÃ¶r om",
        language:"SprÃ¥k", vat:"Moms", include:"inkludera", overage:"Spill", apply:"anvÃ¤nd",
        exact:"Exakt berÃ¤kning (ingen avrundning)", dark:"MÃ¶rkt lÃ¤ge", step:"Steg-fÃ¶r-steg",
        import:"Importera", exportJSON:"Export JSON", exportCSV:"Export CSV", exportExcel:"Export Excel", print:"Skriv ut / PDF",
        templatesTitle:"Globala Produktmallar", addTemplate:"+ LÃ¤gg till mall", applyAllTemplates:"AnvÃ¤nd ALLA pÃ¥ ALLA omrÃ¥den",
        infoTitle:"Info & summeringar", infoEmpty:"Ingen info Ã¤nnu. LÃ¤gg till produkter och ytor.", toast:"Info uppdaterad â€” Visa",
        areaName:"OmrÃ¥desnamn", surface:"Yttyp", factor:"Faktor", size:"Storlek", sq:"mÂ²",
        product:"Produkt", calc:"LÃ¤ge", usage:"Ã…tgÃ¥ng (kg per mÂ²)", usageHint:"Vanligen kg/mÂ² per lager enligt datablad.",
        layers:"Lager", thickness:"Tjocklek (mm)", density:"Densitet (kg/L)",
        packSize:"FÃ¶rp. storlek", unit:"Enhet",
        priceMode:"Pris-lÃ¤ge", perPack:"Pris/fÃ¶rp", perKg:"Pris/kg",
        pricePack:"Pris/fÃ¶rp", priceKg:"Pris/kg",
        needed:"Behov", packages:"FÃ¶rp", cost:"Kostnad",
        addProduct:"+ LÃ¤gg till produktlager",
        calcThickness:"Tjocklek", calcUsage:"Ã…tgÃ¥ng/mÂ²", calcCoverage:"TÃ¤ckning/fÃ¶rp",
        coverSqm:"TÃ¤ckning (mÂ²/fÃ¶rp)", coverLayers:"Lager per fÃ¶rp",
        prodInfo:"Produktdata", projectInfo:"Projekt/OmrÃ¥desdata",
        deleteArea:"Ta bort omrÃ¥de",
        cloneAll:"Klona â†’ Alla", cloneBelow:"Klona â†“ Nedan", breakdown:"â„¹ Breakdown", remove:"Ta bort",
        hoverSurface:"Yta", hoverProduct:"Produkt",
        tmplAdded:"Mall tillagd", tmplApplyAll:"Mall applicerad pÃ¥ alla omrÃ¥den",
        errUnsupported:"Filformatet stÃ¶ds inte.",
        updated:"Uppdaterad ", color:"FÃ¤rg"
      },
      en:{ addArea:"+ Add Area", addAreaBelow:"+ Add Area Below",
        undoText:"Undo", redoText:"Redo",
        language:"Language", vat:"VAT", include:"include", overage:"Overage", apply:"apply",
        exact:"Exact calc (no rounding)", dark:"Dark mode", step:"Step-by-step",
        import:"Import", exportJSON:"Export JSON", exportCSV:"Export CSV", exportExcel:"Export Excel", print:"Print / PDF",
        templatesTitle:"Global Product Templates", addTemplate:"+ Add Template", applyAllTemplates:"Apply ALL to ALL Areas",
        infoTitle:"Info & summaries", infoEmpty:"No info yet. Add products and areas.", toast:"Info updated â€” View",
        areaName:"Area name", surface:"Surface", factor:"Factor", size:"Size", sq:"mÂ²",
        product:"Product", calc:"Mode", usage:"Usage (kg per mÂ²)", usageHint:"Usually kg/mÂ² per layer per data sheet.",
        layers:"Layers", thickness:"Thickness (mm)", density:"Density (kg/L)",
        packSize:"Pack size", unit:"Unit",
        priceMode:"Price Mode", perPack:"Price/pack", perKg:"Price/kg",
        pricePack:"Price/pack", priceKg:"Price/kg",
        needed:"Needed", packages:"Packages", cost:"Cost",
        addProduct:"+ Add Product Layer",
        calcThickness:"Thickness", calcUsage:"Usage/mÂ²", calcCoverage:"Coverage/pack",
        coverSqm:"Coverage (mÂ²/pack)", coverLayers:"Layers per pack",
        prodInfo:"Product info", projectInfo:"Project/Area info",
        deleteArea:"Delete Area",
        cloneAll:"Clone â†’ All", cloneBelow:"Clone â†“ Below", breakdown:"â„¹ Breakdown", remove:"Remove",
        hoverSurface:"Surface", hoverProduct:"Product",
        tmplAdded:"Template added", tmplApplyAll:"Template applied to all areas",
        errUnsupported:"Unsupported file format.",
        updated:"Updated ", color:"Color"
      }
    };
    let LANG="sv";
    function t(k){return (i18n[LANG]&&i18n[LANG][k])||k;}
    function applyI18n(){document.querySelectorAll("[data-i18n]").forEach(el=>{el.textContent=t(el.getAttribute("data-i18n"));}); refreshSummaryLabels();}

    /* ================== STATE ================== */
    const state={
      project:{
        areas:[],
        settings:{
          vatIncluded:false, vatRate:25,
          overageIncluded:false, overagePercent:10,
          exactMode:false, stepMode:false, darkMode:false,
          surfaceTypes:{"Smooth":1.00,"Light Grind":1.05,"Medium Grind":1.10,"Rough":1.15,"Porous/Cracked":1.25},
          surfaceInfo:{
            "Smooth":{title:"Smooth / polished",desc:"Closed pores; dense, burnished surface.",hint:"+0%", prep:"Light cleaning; dust-free", typical:"Troweled/Polished slab"},
            "Light Grind":{title:"Lightly ground",desc:"Micro texture opens; slightly higher uptake.",hint:"+5%", prep:"Degrease + light grind", typical:"Polished with light hone"},
            "Medium Grind":{title:"Medium ground",desc:"Visible sand; micro-cracks possible.",hint:"+10%", prep:"Grinding P80â€“P120", typical:"Traffic-worn interior"},
            "Rough":{title:"Rough / broomed",desc:"Coarse profile; high absorption.",hint:"+15%", prep:"Grinding + vacuum; repair spalls", typical:"Exterior broom finish"},
            "Porous/Cracked":{title:"Highly porous / cracked",desc:"Capillaries & voids; very high absorption with cracks.",hint:"+25%", prep:"Crack injection + primer", typical:"Old slab, freeze-thaw damage"},
            "Custom":{title:"Custom",desc:"User-defined surface factor.",hint:"depends", prep:"â€”", typical:"â€”"}
          }
        }
      },
      undoStack:[], redoStack:[],
      nextAreaId:1, nextProductId:1, nextTemplateId:1,
      lastAddedProductTemplate:null
    };

    /* ================== DOM REFS ================== */
    const areasContainer=document.getElementById("areasContainer");
    const footerTotalLabel=document.getElementById("footerTotalLabel");
    const footerTotalValue=document.getElementById("footerTotalValue");
    const btnAddAreaDock=document.getElementById("btnAddAreaDock");
    const undoBtn=document.getElementById("undo"), redoBtn=document.getElementById("redo");
    const vatToggle=document.getElementById("vatToggle"), vatPercentInput=document.getElementById("vatPercent");
    const overageToggle=document.getElementById("overageToggle"), overagePercentInput=document.getElementById("overagePercent");
    const exactToggle=document.getElementById("exactToggle");
    const darkModeToggle=document.getElementById("darkModeToggle");
    const stepModeToggle=document.getElementById("stepModeToggle");
    const importBtn=document.getElementById("importData"), fileInput=document.getElementById("fileInput");
    const exportJSONBtn=document.getElementById("exportJSON"), exportCSVBtn=document.getElementById("exportCSV"), exportExcelBtn=document.getElementById("exportExcel");
    const printBtn=document.getElementById("printBtn");
    const infoBody=document.getElementById("infoBody"), infoToast=document.getElementById("infoToast");
    const lastInfoTime=document.getElementById("lastInfoTime"), hoverTip=document.getElementById("hoverTip");
    const btnScrollSummary=document.getElementById("btnScrollSummary");
    const logPanel=document.getElementById("logPanel"), logContent=document.getElementById("logContent");
    const minimizeLogBtn=document.getElementById("minimizeLog"), maximizeLogBtn=document.getElementById("maximizeLog");
    const langSV=document.getElementById("langSV"), langEN=document.getElementById("langEN");
    const topAddDock=document.getElementById("topAddDock");

    /* ================== UTIL & LOG ================== */
    function log(msg){
      const tms=new Date().toLocaleTimeString();
      const p=document.createElement("p"); p.textContent=`[${tms}] ${msg}`; logContent.appendChild(p);
      if(logContent.scrollHeight-logContent.clientHeight-logContent.scrollTop<5){logContent.scrollTop=logContent.scrollHeight;}
      const ud=state.undoStack.at(-1)?.desc || (LANG==="sv"?"Inget att Ã¥ngra":"Nothing to undo");
      const rd=state.redoStack.at(-1)?.desc || (LANG==="sv"?"Inget att gÃ¶ra om":"Nothing to redo");
      undoBtn.title = (LANG==="sv"?"Ã…ngra: ":"Undo: ")+ud;
      redoBtn.title = (LANG==="sv"?"GÃ¶r om: ":"Redo: ")+rd;
    }
    function pushStateForUndo(desc){
      const snap=JSON.parse(JSON.stringify(state.project));
      state.undoStack.push({data:snap,desc}); state.redoStack.length=0;
      undoBtn.disabled=state.undoStack.length===0; redoBtn.disabled=true;
      undoBtn.title=(LANG==="sv"?"Ã…ngra: ":"Undo: ")+desc;
      redoBtn.title=(LANG==="sv"?"GÃ¶r om: ":"Redo: ");
    }
    function undo(){ if(!state.undoStack.length) return;
      const last=state.undoStack.pop(); const desc=last.desc;
      state.redoStack.push({data:JSON.parse(JSON.stringify(state.project)),desc});
      state.project=last.data; renderAll(); log(`Undo: ${desc}`);
      undoBtn.disabled=state.undoStack.length===0; redoBtn.disabled=state.redoStack.length===0;
    }
    function redo(){ if(!state.redoStack.length) return;
      const last=state.redoStack.pop(); const desc=last.desc;
      state.undoStack.push({data:JSON.parse(JSON.stringify(state.project)),desc});
      state.project=last.data; renderAll(); log(`Redo: ${desc}`);
      undoBtn.disabled=state.undoStack.length===0; redoBtn.disabled=state.redoStack.length===0;
    }
    function toPosFloat(v,def){const n=parseFloat(v); return (isNaN(n)||n<0)? def : n;}
    function fmt(n){ if(!isFinite(n)) return "0"; if(Math.abs(n)>=1000) return n.toFixed(0); if(Math.abs(n)>=10) return n.toFixed(1); return n.toFixed(2); }
    function downloadBlob(blob,filename){const url=URL.createObjectURL(blob);const a=document.createElement("a");a.href=url;a.download=filename;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);}
    function formatCSVValue(v){const s=String(v);return /[",\n]/.test(s)?`"${s.replace(/"/g,'""')}"`:s;}
    function escapeXML(s){if(s==null) return ""; return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");}
    const showInfoToast=(()=>{let hide=null;return()=>{infoToast.style.display="flex"; if(hide) clearTimeout(hide); hide=setTimeout(()=>infoToast.style.display="none",3500);};})();

    /* ================== SURFACE HELPERS ================== */
    function reverseFindTypeByFactor(f){
      const m=Object.entries(state.project.settings.surfaceTypes).find(([_,v])=>Math.abs(v-f)<1e-6);
      return m?m[0]:null;
    }
    function surfaceExpl(area){
      const k = reverseFindTypeByFactor(area.modifier)||"Custom";
      const meta=state.project.settings.surfaceInfo[k] || state.project.settings.surfaceInfo["Custom"];
      return {type:k,title:meta.title,desc:meta.desc,hint:meta.hint,prep:meta.prep,typical:meta.typical,factor:area.modifier.toFixed(2)};
    }

    /* ================== SEEDED RNG FOR ILLUSTRATION (stable on hover) ================== */
    function PRNG(seed){
      let t = seed>>>0 || 88675123;
      return function(){
        t += 0x6D2B79F5;
        let r = t ^ (t>>>15); r = Math.imul(r, 1 | r);
        r ^= r + Math.imul(r ^ (r>>>7), 61 | r);
        return ((r ^ (r>>>14))>>>0) / 4294967296;
      };
    }

    /* ================== CANVAS ILLUSTRATION ================== */
    function drawCracks(ctx, rect, prng, density=6, color="rgba(0,0,0,.25)"){
      ctx.save(); ctx.strokeStyle=color; ctx.lineWidth=1;
      for(let i=0;i<density;i++){
        let x = rect.x + prng()*rect.w;
        let y = rect.y + prng()*rect.h;
        ctx.beginPath(); ctx.moveTo(x,y);
        for(let j=0;j<6;j++){
          x += (prng()*20-10);
          y += (prng()*10-5);
          ctx.lineTo(x,y);
        }
        ctx.stroke();
      }
      ctx.restore();
    }
    function drawRugged(ctx, rect, prng){
      ctx.save();
      for(let i=0;i<160;i++){
        const x=rect.x + prng()*rect.w;
        const y=rect.y + prng()*rect.h;
        const r=prng()*2.2+0.6;
        ctx.fillStyle=`rgba(0,0,0,${prng()*0.06+0.04})`;
        ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
      }
      ctx.restore();
    }
    function drawSpeckles(ctx, rect, prng, amount=120){
      ctx.save();
      for(let i=0;i<amount;i++){
        const x=rect.x + prng()*rect.w;
        const y=rect.y + prng()*rect.h;
        ctx.fillStyle=`rgba(0,0,0,${prng()*0.06})`;
        ctx.fillRect(x,y,1,1);
      }
      ctx.restore();
    }
    function drawMicroScratches(ctx, rect, prng, amount=80){
      ctx.save(); ctx.strokeStyle="rgba(0,0,0,.08)"; ctx.lineWidth=.6;
      for(let i=0;i<amount;i++){
        const x = rect.x + prng()*rect.w;
        const y = rect.y + prng()*rect.h;
        const len = prng()*12+4;
        const ang = prng()*Math.PI*2;
        ctx.beginPath();
        ctx.moveTo(x,y);
        ctx.lineTo(x+Math.cos(ang)*len, y+Math.sin(ang)*len);
        ctx.stroke();
      }
      ctx.restore();
    }
    function baseConcreteColor(area){
      const f=area.modifier; const l = 90 - Math.min(28,(f-1)*65);
      return `hsl(215 14% ${l}%)`;
    }
    function layerColor(p){
      return p.color || (()=>{let h=0;const s=(p.name||"Layer");for(let i=0;i<s.length;i++)h=(h*31+s.charCodeAt(i))>>>0; return `hsl(${h%360} 70% 55%)`;})();
    }
    function drawAreaIllustration(canvas, area, hoverIdx=-1, hoverSlab=false){
      const ctx=canvas.getContext("2d");
      const W=canvas.width=canvas.clientWidth, H=canvas.height=canvas.clientHeight;
      ctx.clearRect(0,0,W,H);

      const prng=PRNG(area.id*10007 + Math.floor(area.modifier*1000));

      // slab
      const slabH=22; const slabY=H-slabH; ctx.fillStyle=baseConcreteColor(area);
      ctx.fillRect(0,slabY,W,slabH);
      ctx.strokeStyle="rgba(0,0,0,.08)"; ctx.beginPath(); for(let x=0;x<W;x+=10){ctx.moveTo(x,slabY);ctx.lineTo(x+5,slabY+5);} ctx.stroke();

      const st=reverseFindTypeByFactor(area.modifier)||"Custom";
      const slabRect={x:0,y:slabY,w:W,h:slabH};
      if(st==="Smooth"){ drawSpeckles(ctx,slabRect,prng,60); drawMicroScratches(ctx,slabRect,prng,60); }
      else if(st==="Light Grind"){ drawSpeckles(ctx,slabRect,prng,100); drawMicroScratches(ctx,slabRect,prng,80); }
      else if(st==="Medium Grind"){ drawSpeckles(ctx,slabRect,prng,150); drawRugged(ctx,slabRect,prng); }
      else if(st==="Rough"){ drawRugged(ctx,slabRect,prng); drawSpeckles(ctx,slabRect,prng,80); }
      else if(st==="Porous/Cracked"){ drawRugged(ctx,slabRect,prng); drawCracks(ctx,slabRect,prng,7); }

      // layers
      const totalLayers = area.products.reduce((a,p)=>a+Math.max(1,Number(p.layers||1)),0)||1;
      const space = H-slabH-10, gap=1.5, unitH=(space-gap*(totalLayers-1))/Math.max(1,totalLayers);
      const rects=[]; let y=H-slabH-gap;
      area.products.forEach(p=>{
        const L=Math.max(1,Number(p.layers||1));
        for(let i=0;i<L;i++){
          const h=unitH, top=y-h, col = layerColor(p);
          ctx.save(); ctx.globalAlpha = (hoverSlab?0.9:1);
          if(rects.length===hoverIdx) ctx.filter="brightness(1.24)";
          ctx.fillStyle=col;
          ctx.fillRect(6,top,W-12,h);
          ctx.restore();
          ctx.strokeStyle="rgba(0,0,0,.15)"; ctx.strokeRect(6,top,W-12,h);
          rects.push({x:6,y:top,w:W-12,h, product:p});
          y = top - gap;
        }
      });

      canvas._layerRects=rects;
      canvas._slabRect=slabRect;
    }
    function attachCanvasInteractions(canvas, area, inlineRow){
      const tip=hoverTip;
      const show=(html,x,y)=>{tip.innerHTML=html; tip.style.display="block"; const pad=10; tip.style.left=(x+pad)+"px"; tip.style.top=(y+pad)+"px";}
      const hide=()=>{tip.style.display="none";}
      const showInline=(html)=>{ inlineRow.innerHTML=html; inlineRow.classList.add("show"); }
      const hideInline=()=>{ inlineRow.classList.remove("show"); inlineRow.innerHTML=""; }

      canvas.addEventListener("mousemove",(e)=>{
        const r=canvas.getBoundingClientRect(); const x=e.clientX-r.left, y=e.clientY-r.top;
        const rects=canvas._layerRects||[]; let idx=-1;
        for(let i=0;i<rects.length;i++){const L=rects[i]; if(x>=L.x&&x<=L.x+L.w&&y>=L.y&&y<=L.y+L.h){idx=i; break;}}
        const slab=canvas._slabRect; const onSlab = slab && x>=slab.x && x<=slab.x+slab.w && y>=slab.y && y<=slab.y+slab.h;
        drawAreaIllustration(canvas,area,idx,onSlab);
        if(idx>-1){
          const p=rects[idx].product;
          const html = `<div><strong>${t("hoverProduct")}:</strong> ${p.name||"-"}</div>
            <div>â€¢ ${t("layers")}: ${p.layers||1} â€¢ ${t("thickness")}: ${p.thickness||0} mm</div>
            <div>â€¢ ${t("unit")}: ${p.packUnit||"kg"} â€¢ ${t("packSize")}: ${p.packSize||0}</div>
            <div>â€¢ ${(p.priceMode==='perKg')?t("priceKg"):t("pricePack")}: ${p.price||0}</div>`;
          show(html,e.clientX,e.clientY);
          hideInline();
        }else if(onSlab){
          const meta=surfaceExpl(area);
          const html = `<strong>${t("hoverSurface")}:</strong> ${meta.title} (Ã—${meta.factor}) â€” ${meta.hint}. ${meta.desc}`;
          show(html,e.clientX,e.clientY);
          showInline(html);
        }else{ hide(); hideInline(); }
      });
      canvas.addEventListener("mouseleave",()=>{drawAreaIllustration(canvas,area,-1,false); hoverTip.style.display="none"; hideInline();});
    }

    /* ================== EL HELPER ================== */
    function el(tag,attrs={},txt){const e=document.createElement(tag);Object.entries(attrs).forEach(([k,v])=>{if(k==="class")e.className=v;else if(k==="style")e.setAttribute("style",v);else e.setAttribute(k,v);});if(txt!=null)e.textContent=txt;return e;}
    function cloneProductData(prod){
      return JSON.parse(JSON.stringify({
        name:prod.name||"", color:prod.color||null,
        layers:prod.layers||1, thickness:prod.thickness||0, density:(prod.density===null?null:prod.density||0),
        packSize:prod.packSize||1, packUnit:prod.packUnit||"kg",
        price:prod.price||0, priceMode:prod.priceMode||"perPack",
        calcMode: prod.calcMode || "thickness",
        usagePerM2: prod.usagePerM2 || 0,
        coverSqmPerPack: prod.coverSqmPerPack || 0,
        coverLayersPerPack: prod.coverLayersPerPack || 1
      }));
    }

    /* ================== AREA UI ================== */
    function createAreaElement(area){
      const wrap=el("div",{class:"area","data-area-id":area.id});

      // header
      const header=el("div",{class:"area-header"});

      const nameI=el("input",{type:"text",value:area.name,placeholder:t("areaName")});
      nameI.addEventListener("change",()=>{const old=area.name; area.name=nameI.value; log(`Renamed area "${old}" â†’ "${area.name}"`);});
      header.appendChild(nameI);

      const surfaceSel=el("select",{title:t("surface")});
      Object.keys(state.project.settings.surfaceTypes).concat(["Custom"]).forEach(n=>{
        const o=el("option",{value:n}); o.textContent=n; surfaceSel.appendChild(o);
      });
      const matched=reverseFindTypeByFactor(area.modifier)||"Custom"; surfaceSel.value=matched;
      header.appendChild(surfaceSel);

      const modI=el("input",{type:"number",step:"0.01",value:area.modifier}); modI.disabled=(matched!=="Custom");
      header.appendChild(modI);

      const sizeWrap=el("div",{class:"unit-wrap"});
      const sizeI=el("input",{type:"number",min:"0",step:"0.1",value:area.size||0,placeholder:t("size")});
      const unit=el("div",{class:"unit"},t("sq"));
      sizeWrap.appendChild(sizeI); sizeWrap.appendChild(unit); header.appendChild(sizeWrap);

      // mini caption below title line
      const miniCap=el("div",{class:"mini-caption"}, `${t("prodInfo")} / ${t("projectInfo")}`);
      header.appendChild(miniCap);

      // small illustration top-right
      const mini=el("div",{class:"mini-illustration"});
      const canvas=document.createElement("canvas"); mini.appendChild(canvas);
      header.appendChild(mini);

      const del=el("button",{class:"del-area",title:t("deleteArea")}, t("deleteArea"));
      del.addEventListener("click",()=>removeArea(wrap));
      header.appendChild(del);

      wrap.appendChild(header);

      // table (re-ordered columns: move density/pack/price & priceMode to PRODUCTDATA)
      const table=el("table",{class:"area-table","data-area-id":area.id});
      const thead=el("thead");
      const grp=el("tr");
      grp.appendChild(el("th",{class:"th-group",colspan:"11"},t("prodInfo")));
      grp.appendChild(el("th",{class:"th-group",colspan:"5"},t("projectInfo")));
      thead.appendChild(grp);

      const head=el("tr");
      ["",t("product"),t("color"),t("calc"),t("usage"),t("density"),t("packSize"),t("unit"),t("priceMode"),t("pricePack"),t("coverSqm"),t("coverLayers"),
       t("layers"),t("thickness"),t("needed"),t("packages"),t("cost")].forEach(h=>head.appendChild(el("th",{},h)));
      thead.appendChild(head);
      table.appendChild(thead);

      const tbody=el("tbody"); tbody.setAttribute("data-area-id", area.id);
      area.products.forEach((p)=>tbody.appendChild(buildProductRow(area,p)));
      table.appendChild(tbody);

      // inline surface info
      const inlineInfo=el("div",{class:"surface-inline","data-bind":"inlineSurface"});
      wrap.appendChild(table);
      wrap.appendChild(inlineInfo);

      // footer buttons â€” stacked, same vertical line & size
      const btnWrap=el("div",{class:"footer-buttons"});
      const addProdBtn=el("button",{class:"btn btn-primary btn-slim"}, t("addProduct"));
      addProdBtn.addEventListener("click",()=>{
        const firstAdd = area.products.length===0 && state.lastAddedProductTemplate;
        const frag = addProduct(area,tbody);
        if(firstAdd){
          if(confirm(`Klona senaste produkt "${state.lastAddedProductTemplate.name}" till detta omrÃ¥de?`)){
            applyProductDataToRow(area,frag,state.lastAddedProductTemplate);
            log(`Cloned last product template to "${area.name}"`);
            updateCalculations(true);
          }
        }
      });
      btnWrap.appendChild(addProdBtn);

      // "LÃ¤gg till omrÃ¥de" (NOT "under") â€” aligned & same width as product button
      const addAreaAfter=el("button",{class:"btn btn-primary btn-slim"}, t("addArea"));
      addAreaAfter.addEventListener("click",()=>insertAreaAfter(area.id));
      btnWrap.appendChild(addAreaAfter);
      wrap.appendChild(btnWrap);

      // listeners
      function updateAreaInfoboxAndCanvas(showInline=false){
        const meta=surfaceExpl(area);
        drawAreaIllustration(canvas,area);
        attachCanvasInteractions(canvas,area,inlineInfo);
        if(showInline){
          inlineInfo.innerHTML = `<strong>${t("hoverSurface")}:</strong> ${meta.title} (Ã—${meta.factor}) â€” ${meta.hint}. ${meta.desc}`;
          inlineInfo.classList.add("show");
        }
      }
      updateAreaInfoboxAndCanvas();

      surfaceSel.addEventListener("change",()=>{
        if(surfaceSel.value==="Custom"){ modI.disabled=false; }
        else{
          area.modifier=state.project.settings.surfaceTypes[surfaceSel.value];
          modI.value=area.modifier; modI.disabled=true;
          log(`Surface "${area.name}" â†’ ${surfaceSel.value} (x${area.modifier})`);
          updateCalculations(true);
        }
        updateAreaInfoboxAndCanvas(true);
      });
      surfaceSel.addEventListener("mouseenter",()=>updateAreaInfoboxAndCanvas(true));
      surfaceSel.addEventListener("mouseleave",()=>{inlineInfo.classList.remove("show"); inlineInfo.innerHTML="";});

      modI.addEventListener("change",()=>{
        const v=toPosFloat(modI.value,1.0); modI.value=v; area.modifier=v;
        surfaceSel.value = reverseFindTypeByFactor(v) || "Custom";
        if(surfaceSel.value!=="Custom"){ modI.disabled=true; }
        log(`Surface factor "${area.name}" â†’ ${v}`);
        updateCalculations(true); updateAreaInfoboxAndCanvas(true);
      });
      const sizeIChange=()=>{const v=toPosFloat(sizeI.value,0); sizeI.value=v; area.size=v; log(`Area size "${area.name}" â†’ ${v} mÂ²`); updateCalculations();};
      sizeI.addEventListener("change",sizeIChange);

      // enable sorting
      enableDragSort(tbody, area);

      return wrap;
    }

    function buildProductRow(area,product){
      if(!product.calcMode) product.calcMode="thickness";
      if(product.usagePerM2==null) product.usagePerM2=0;
      if(product.coverSqmPerPack==null) product.coverSqmPerPack=0;
      if(product.coverLayersPerPack==null||product.coverLayersPerPack<=0) product.coverLayersPerPack=1;
      if(!product.priceMode) product.priceMode="perPack";

      const tr=el("tr",{class:"product-row","data-product-id":product.id, draggable:"true"});
      const td=(child,cls)=>{const c=document.createElement("td"); if(cls) c.className=cls; c.appendChild(child); return c;};

      const drag=el("span",{class:"drag-handle",title:"Drag to reorder"},"â˜°");
      tr.appendChild(td(drag,"td-prod"));

      const nameI=el("input",{type:"text",value:product.name,placeholder:t("product")});
      nameI.addEventListener("change",()=>{product.name=nameI.value; state.lastAddedProductTemplate=cloneProductData(product); log(`Renamed product ${product.id} in "${area.name}" â†’ "${product.name}"`);});
      tr.appendChild(td(nameI,"td-prod"));

      const colorI=el("input",{type:"color",value:product.color||"#6cb2ff",title:t("color")});
      colorI.addEventListener("input",()=>{product.color=colorI.value; const canv=document.querySelector(`.area[data-area-id="${area.id}"] .mini-illustration canvas`); if(canv) drawAreaIllustration(canv,area);});
      tr.appendChild(td(colorI,"td-prod"));

      const mode=el("select");
      [["thickness",t("calcThickness")],["usage",t("calcUsage")],["coverage",t("calcCoverage")]]
        .forEach(([v,l])=>{const o=el("option",{value:v});o.textContent=l;mode.appendChild(o);});
      mode.value=product.calcMode;
      tr.appendChild(td(mode,"td-prod"));

      const usageI=el("input",{type:"number",min:"0",step:"0.001",value:product.usagePerM2||0, title:t("usageHint")}); 
      tr.appendChild(td(usageI,"td-prod"));

      const densI=el("input",{type:"number",min:"0",step:"0.01",value:(product.density??"")}); densI.placeholder=t("density");
      tr.appendChild(td(densI,"td-prod"));

      const packI=el("input",{type:"number",min:"0.0001",step:"0.1",value:product.packSize||1});
      packI.addEventListener("change",()=>{product.packSize=Math.max(0.0001,parseFloat(packI.value)||1); packI.value=product.packSize; log(`Pack size "${product.name}" â†’ ${product.packSize} ${product.packUnit}`); updateCalculations();});
      tr.appendChild(td(packI,"td-prod"));

      const unitSel=el("select"); ["kg","L"].forEach(u=>{const o=el("option",{value:u});o.textContent=u; unitSel.appendChild(o);}); unitSel.value=product.packUnit||"kg";
      tr.appendChild(td(unitSel,"td-prod"));

      const priceModeSel=el("select");
      [["perPack",t("perPack")],["perKg",t("perKg")]].forEach(([v,l])=>{const o=el("option",{value:v});o.textContent=l;priceModeSel.appendChild(o);});
      priceModeSel.value=product.priceMode;
      tr.appendChild(td(priceModeSel,"td-prod"));

      const priceI=el("input",{type:"number",min:"0",step:"0.01",value:product.price||0, placeholder:t("pricePack")});
      tr.appendChild(td(priceI,"td-prod"));

      const coverSqmI=el("input",{type:"number",min:"0",step:"0.1",value:product.coverSqmPerPack||0}); 
      tr.appendChild(td(coverSqmI,"td-prod"));

      const coverLayersI=el("input",{type:"number",min:"1",step:"1",value:product.coverLayersPerPack||1}); 
      tr.appendChild(td(coverLayersI,"td-prod"));

      const layersI=el("input",{type:"number",min:"1",step:"1",value:product.layers||1});
      layersI.addEventListener("change",()=>{product.layers=Math.max(1,parseInt(layersI.value)||1); layersI.value=product.layers; log(`Layers "${product.name}" â†’ ${product.layers}`); updateCalculations();});
      tr.appendChild(td(layersI,"td-proj"));

      const thickI=el("input",{type:"number",min:"0",step:"0.1",value:product.thickness||0});
      thickI.addEventListener("change",()=>{product.thickness=toPosFloat(thickI.value,0); thickI.value=product.thickness; log(`Thickness "${product.name}" â†’ ${product.thickness} mm`); updateCalculations();});
      tr.appendChild(td(thickI,"td-proj"));

      const needSpan=el("span",{class:"neededQty"},"0"); tr.appendChild(td(needSpan,"td-proj"));
      const pkgSpan=el("span",{class:"packageCount"},"0"); tr.appendChild(td(pkgSpan,"td-proj"));
      const costSpan=el("span",{class:"cost"},"0"); tr.appendChild(td(costSpan,"td-proj"));

      // overlay actions
      const overlay=el("div",{class:"row-actions-overlay"});
      const cloneAll=el("button",{class:"mini ghost","data-i18n":"cloneAll"},t("cloneAll"));
      const cloneBelow=el("button",{class:"mini ghost","data-i18n":"cloneBelow"},t("cloneBelow"));
      const infoBtn=el("button",{class:"mini warn","data-i18n":"breakdown"},t("breakdown"));
      const delBtn=el("button",{class:"mini danger","data-i18n":"remove"},t("remove"));
      overlay.appendChild(cloneAll); overlay.appendChild(cloneBelow); overlay.appendChild(infoBtn); overlay.appendChild(delBtn);
      tr.appendChild(overlay);

      // breakdown row
      const br=document.createElement("tr"); br.className="breakdown";
      const brtd=document.createElement("td"); brtd.colSpan=16; br.appendChild(brtd);
      const brbox=el("div",{class:"breakdown"}); brtd.appendChild(brbox);

      // mode binding & interactions
      function bindModeUI(){
        const M=product.calcMode;
        const isUsage=(M==="usage"), isThick=(M==="thickness"), isCover=(M==="coverage");
        usageI.disabled=!isUsage;
        thickI.disabled=!isThick;
        densI.disabled= (M!=="thickness") || (unitSel.value==="L");
        coverSqmI.disabled=!isCover; coverLayersI.disabled=!isCover;
      }
      bindModeUI();

      const applyCalc=()=>updateCalculations();
      unitSel.addEventListener("change",()=>{product.packUnit=unitSel.value; bindModeUI(); log(`Unit "${product.name}" â†’ ${product.packUnit}`); applyCalc();});
      mode.addEventListener("change",()=>{product.calcMode=mode.value; bindModeUI(); log(`Mode "${product.name}" â†’ ${product.calcMode}`); updateCalculations(true);});
      usageI.addEventListener("change",()=>{product.usagePerM2=toPosFloat(usageI.value,0); usageI.value=product.usagePerM2; state.lastAddedProductTemplate=cloneProductData(product); applyCalc();});
      densI.addEventListener("change",()=>{const v=toPosFloat(densI.value,0); product.density=(densI.value===""?null:v); applyCalc();});
      coverSqmI.addEventListener("change",()=>{product.coverSqmPerPack=toPosFloat(coverSqmI.value,0); applyCalc();});
      coverLayersI.addEventListener("change",()=>{product.coverLayersPerPack=Math.max(1,parseInt(coverLayersI.value)||1); coverLayersI.value=product.coverLayersPerPack; applyCalc();});
      priceModeSel.addEventListener("change",()=>{product.priceMode=priceModeSel.value; priceI.placeholder = (product.priceMode==='perKg')?t("priceKg"):t("pricePack"); applyCalc();});
      priceI.addEventListener("change",()=>{product.price=toPosFloat(priceI.value,0); priceI.value=product.price.toFixed(2); log(`Price "${product.name}" â†’ ${product.price} (${product.priceMode})`); applyCalc();});

      delBtn.addEventListener("click",()=>removeProduct(area,product.id));
      cloneAll.addEventListener("click",()=>{
        pushStateForUndo(`Clone "${product.name}" to all areas`);
        state.project.areas.forEach(a=>{ if(a.id!==area.id){const c=cloneProductData(product); c.id=state.nextProductId++; a.products.push(c);} });
        log(`Cloned "${product.name}" to all areas`); renderAll();
      });
      cloneBelow.addEventListener("click",()=>{
        pushStateForUndo(`Clone "${product.name}" to areas below`);
        const idxA=state.project.areas.findIndex(a=>a.id===area.id);
        state.project.areas.slice(idxA+1).forEach(a=>{const c=cloneProductData(product); c.id=state.nextProductId++; a.products.push(c);});
        log(`Cloned "${product.name}" to areas below`); renderAll();
      });
      infoBtn.addEventListener("click",()=>{
        state.project.settings.stepMode=!state.project.settings.stepMode;
        stepModeToggle.checked=state.project.settings.stepMode;
        document.body.classList.toggle("step-on",state.project.settings.stepMode); updateCalculations(true);
      });

      const frag=document.createDocumentFragment();
      frag.appendChild(tr); frag.appendChild(br);
      return frag;
    }

    function addProduct(area,tbody){
      const p={id:state.nextProductId++,name:"",color:null,layers:1,thickness:0,density:null,packSize:1,packUnit:"kg",price:0,priceMode:"perPack",
        calcMode:"thickness",usagePerM2:0,coverSqmPerPack:0,coverLayersPerPack:1};
      area.products.push(p);
      const frag=buildProductRow(area,p);
      tbody.appendChild(frag);
      log(`Added product in "${area.name}" (ID ${p.id})`);
      pushStateForUndo(`Added product in area ${area.name}`);
      updateCalculations();
      return frag;
    }
    function applyProductDataToRow(area,frag,data){
      const prod=area.products[area.products.length-1];
      Object.assign(prod, cloneProductData(data));
      const areaEl=areasContainer.querySelector(`.area[data-area-id="${area.id}"]`);
      if(areaEl){ areaEl.replaceWith(createAreaElement(area)); }
    }
    function insertAreaAfter(areaId){
      const idx=state.project.areas.findIndex(a=>a.id===areaId);
      const id=state.nextAreaId++;
      const nm=(LANG==="sv"?"OmrÃ¥de ":"Area ")+id;
      const a={id,name:nm,modifier:state.project.settings.surfaceTypes["Smooth"],size:0,products:[]};
      pushStateForUndo(`Insert area after ${areaId}`);
      state.project.areas.splice(idx+1,0,a);
      renderAll(); log(`Added area "${nm}"`);
    }
    function removeArea(areaElem){
      const id=parseInt(areaElem.dataset.areaId);
      const idx=state.project.areas.findIndex(a=>a.id===id); if(idx===-1) return;
      const nm=state.project.areas[idx].name||`Area ${id}`;
      pushStateForUndo(`Removed area ${nm}`); state.project.areas.splice(idx,1);
      areaElem.remove(); log(`Removed area "${nm}"`); updateCalculations(true);
      // If no areas left, show top dock button again
      if(state.project.areas.length===0){ topAddDock.style.display="flex"; }
    }
    function removeProduct(area,prodId){
      const i=area.products.findIndex(p=>p.id===prodId); if(i===-1) return;
      const nm=area.products[i].name||"(unnamed)";
      area.products.splice(i,1);
      const areaEl=areasContainer.querySelector(`.area[data-area-id="${area.id}"]`);
      if(areaEl){ areaEl.querySelectorAll(`tr.product-row[data-product-id="${prodId}"], tr.breakdown`).forEach(r=>r.remove()); }
      log(`Removed product "${nm}" from "${area.name}"`); pushStateForUndo(`Removed product from area ${area.name}`); updateCalculations(true);
    }

    /* ================== DRAG SORT ================== */
    function enableDragSort(tbody, area){
      let dragId=null;
      tbody.addEventListener("dragstart",(e)=>{
        const row=e.target.closest(".product-row"); if(!row) return;
        dragId = parseInt(row.getAttribute("data-product-id"));
        row.classList.add("dragging");
        e.dataTransfer.effectAllowed="move";
      });
      tbody.addEventListener("dragend",(e)=>{
        const row=e.target.closest(".product-row"); if(row) row.classList.remove("dragging");
      });
      tbody.addEventListener("dragover",(e)=>{
        e.preventDefault();
        const after = getDragAfterElement(tbody,e.clientY);
        const dragging=tbody.querySelector(".product-row.dragging");
        if(!dragging) return;
        if(after==null) tbody.appendChild(dragging);
        else tbody.insertBefore(dragging,after);
      });
      tbody.addEventListener("drop",()=>{
        if(dragId==null) return;
        const order=[...tbody.querySelectorAll(".product-row")].map(r=>parseInt(r.getAttribute("data-product-id")));
        const newProducts = order.map(id=> area.products.find(p=>p.id===id) );
        if(newProducts.every(Boolean)){
          pushStateForUndo(`Reorder products in ${area.name}`);
          area.products = newProducts;
          renderAll();
          log(`Reordered products in "${area.name}"`);
        }
        dragId=null;
      });
    }
    function getDragAfterElement(container, y){
      const els=[...container.querySelectorAll(".product-row:not(.dragging)")];
      return els.reduce((closest,child)=>{
        const box=child.getBoundingClientRect();
        const offset=y - box.top - box.height/2;
        if(offset<0 && offset>closest.offset){ return {offset,element:child}; } else { return closest; }
      },{offset:Number.NEGATIVE_INFINITY}).element;
    }

    /* ================== CALCULATIONS ================== */
    function refreshSummaryLabels(){
      const S=state.project.settings;
      const label = S.vatIncluded
        ? (LANG==="sv" ? "Projektets totalsumma (inkl. moms):" : "Project total (incl. VAT):")
        : (LANG==="sv" ? "Projektets totalsumma (exkl. moms):" : "Project total (excl. VAT):");
      footerTotalLabel.textContent = label;
    }

    function updateCalculations(fromSurface=false){
      const S=state.project.settings;
      let totalCostExVAT=0;
      const totalsMap=new Map(); // name|unit -> aggregate

      state.project.areas.forEach(area=>{
        let areaCost=0;
        const areaEl=areasContainer.querySelector(`.area[data-area-id="${area.id}"]`);
        const rows = areaEl ? areaEl.querySelectorAll("tbody tr.product-row"): [];

        area.products.forEach((p,idx)=>{
          const areaSize=Number(area.size)||0;
          const layers = Math.max(1, Number(p.layers)||1);
          const unit   = p.packUnit||"kg";
          const price  = Number(p.price)||0;
          const pack   = Math.max(0.0001, Number(p.packSize)||0);
          const priceMode = p.priceMode || "perPack";

          let neededUnits=0;  // kg or L
          let packages=0;
          let breakdown=[];

          if(p.calcMode==="usage"){
            const use=Number(p.usagePerM2)||0; // kg/L per mÂ² per layer
            let base= areaSize * layers * use;
            breakdown.push(`Base = Area(${areaSize}) Ã— Layers(${layers}) Ã— Usage(${use}/${unit}Â·mÂ²) = ${fmt(base)}`);
            base *= area.modifier; breakdown.push(`Ã— Surface ${area.modifier} â‡’ ${fmt(base)}`);
            if(S.overageIncluded){base*= (1+S.overagePercent/100); breakdown.push(`+ Overage ${S.overagePercent}% â‡’ ${fmt(base)}`);}
            neededUnits = base;
            packages = S.exactMode ? (neededUnits/pack) : Math.ceil(neededUnits/pack);

          }else if(p.calcMode==="thickness"){
            const th=Number(p.thickness)||0; let volL = areaSize * th * layers; // L
            breakdown.push(`Volume L = Area(${areaSize}) Ã— Thickness(${th}) Ã— Layers(${layers}) = ${fmt(volL)} L`);
            volL *= area.modifier; breakdown.push(`Ã— Surface ${area.modifier} â‡’ ${fmt(volL)} L`);
            if(S.overageIncluded){volL*= (1+S.overagePercent/100); breakdown.push(`+ Overage ${S.overagePercent}% â‡’ ${fmt(volL)} L`);}
            if(unit==="kg"){
              const dens = Number(p.density)||0;
              if(dens>0){ neededUnits = volL * dens; breakdown.push(`Needed kg = ${fmt(volL)} Ã— ${dens} = ${fmt(neededUnits)} kg`); }
              else { neededUnits=0; breakdown.push(`Density missing â‡’ 0 kg`); }
            }else{ neededUnits = volL; breakdown.push(`Needed L = ${fmt(neededUnits)} L`); }
            packages = S.exactMode ? (neededUnits/pack) : Math.ceil(neededUnits/pack);

          }else{ // coverage
            const cov=Number(p.coverSqmPerPack)||0; const covLayers=Math.max(1,Number(p.coverLayersPerPack)||1);
            const packsNeeded = cov>0 ? (areaSize * (layers/covLayers) / cov) : 0;
            packages = S.exactMode ? packsNeeded : Math.ceil(packsNeeded);
            neededUnits = packages * pack;
            breakdown.push(`Packs = Area(${areaSize}) Ã— (Layers ${layers}/${covLayers}) Ã· ${cov} = ${fmt(packsNeeded)} ${S.exactMode?"(exact)":""}`);
            breakdown.push(`Units = Packs Ã— PackSize = ${fmt(packages)} Ã— ${pack} = ${fmt(neededUnits)} ${unit}`);
          }

          // COST by price mode
          const cost = (priceMode==='perKg') ? (neededUnits * price) : (packages * price);
          areaCost += cost;

          // update UI row
          const prodRow = rows[idx];
          if(prodRow){
            const needSpan=prodRow.querySelector(".neededQty");
            const pkgSpan =prodRow.querySelector(".packageCount");
            const costSpan=prodRow.querySelector(".cost");
            if(needSpan) needSpan.textContent = neededUnits ? `${fmt(neededUnits)} ${unit}` : "0";
            if(pkgSpan)  pkgSpan.textContent  = S.exactMode ? fmt(packages) : String(packages||0);
            if(costSpan) costSpan.textContent = cost.toFixed(2);

            // breakdown box
            const brRow=prodRow.nextElementSibling;
            if(brRow && brRow.querySelector(".breakdown")){
              const box=brRow.querySelector(".breakdown");
              box.innerHTML = `
                <div><strong>${p.name||"Product"} â€” ${p.calcMode} â€” ${(p.priceMode==='perKg')?t("priceKg"):t("pricePack")}</strong></div>
                <div>${breakdown.join("<br/>")}</div>
                <div><strong>Cost</strong> = ${(p.priceMode==='perKg')?'Needed Ã— Price/kg':'Packages Ã— Price/pack'} = ${(p.priceMode==='perKg')?fmt(neededUnits): (S.exactMode?fmt(packages):packages)} Ã— ${price} = <strong>${cost.toFixed(2)}</strong></div>
              `;
              brRow.style.display = S.stepMode ? "" : "none";
            }
          }

          // aggregate totals for info summary
          const key=(p.name||"(unnamed)")+"|"+unit;
          const rec= totalsMap.get(key) || {name:(p.name||"(unnamed)"),unit,needed:0,pack:pack,price:price,priceMode:priceMode,exactPackages:0};
          rec.needed += neededUnits;
          rec.exactPackages += (neededUnits/pack);
          totalsMap.set(key,rec);
        });

        totalCostExVAT += areaCost;

        const canv=areasContainer.querySelector(`.area[data-area-id="${area.id}"] .mini-illustration canvas`);
        if(canv) drawAreaIllustration(canv,area);
      });

      const label = state.project.settings.vatIncluded
        ? (LANG==="sv"?"Projektets totalsumma (inkl. moms):":"Project total (incl. VAT):")
        : (LANG==="sv"?"Projektets totalsumma (exkl. moms):":"Project total (excl. VAT):");
      footerTotalLabel.textContent=label;
      const displayCost = state.project.settings.vatIncluded ? (totalCostExVAT*(1+state.project.settings.vatRate/100)).toFixed(2) : totalCostExVAT.toFixed(2);
      footerTotalValue.textContent = displayCost;

      renderTotalsInfo(totalsMap, state.project.settings);

      if(fromSurface) { lastInfoTime.textContent = t("updated")+new Date().toLocaleTimeString(); showInfoToast(); }
    }

    function renderTotalsInfo(totalsMap, S){
      const arr=[...totalsMap.values()];
      const info = document.getElementById("infoBody");
      if(!arr.length){ info.innerHTML = `
        <div class="info-card" id="moistureCard">
          <strong>Fukt & fuktighet</strong>
          <p style="margin:.4em 0 .2em 0; color:var(--muted)">
            HÃ¶g fukthalt i underlag/luft kan Ã¶ka Ã¥tgÃ¥ngen (absorptionsfÃ¶rluster) och fÃ¶rlÃ¤nga torktider. Rekommendation:
            torr och dammfri yta, RF â‰¤ 75â€“80% nÃ¤r datablad krÃ¤ver det, provyta vid tveksamhet.
            <em>(Informativt â€” pÃ¥verkar inte berÃ¤kning automatiskt.)</em>
          </p>
        </div>
        <em>${t("infoEmpty")}</em>`; 
        return; 
      }
      const parts=[
        `<div class="info-card" id="moistureCard">
          <strong>Fukt & fuktighet</strong>
          <p style="margin:.4em 0 .2em 0; color:var(--muted)">
            HÃ¶g fukthalt i underlag/luft kan Ã¶ka Ã¥tgÃ¥ngen och fÃ¶rlÃ¤nga torktider. Torka och dammsug ytan noga. FÃ¶lj databladens klimatkrav.
            <em>(Informativt â€” pÃ¥verkar inte berÃ¤kning automatiskt.)</em>
          </p>
        </div>`
      ];
      arr.forEach(rec=>{
        const exactPk = rec.exactPackages;
        const roundedPk = Math.ceil(exactPk);
        const recommendedPk = roundedPk + 1;
        const exactCost = (rec.priceMode==='perKg') ? (rec.needed*rec.price) : (exactPk*rec.price);
        const roundedCost = (rec.priceMode==='perKg') ? (rec.needed*rec.price) : (roundedPk*rec.price);
        const recommendedCost = (rec.priceMode==='perKg') ? (rec.needed*rec.price) : (recommendedPk*rec.price);

        parts.push(`
          <div class="product-total">
            <h5>${rec.name} <span class="dim">[${rec.unit}]</span></h5>
            <div>${LANG==="sv"?"Totalt behov":"Total need"}: <strong>${fmt(rec.needed)} ${rec.unit}</strong></div>
            <div>${LANG==="sv"?"FÃ¶rpackningar":"Packages"}: ${LANG==="sv"?"exakt":"exact"} ${fmt(exactPk)}, ${LANG==="sv"?"avrundat":"rounded"} ${roundedPk}, <em>${LANG==="sv"?"rekommenderat":"recommended"}</em> ${recommendedPk} (${LANG==="sv"?"ta lite extra fÃ¶r sÃ¤kerhets skull":"take a little extra for safety"})</div>
            <div>${LANG==="sv"?"Kostnad":"Cost"} (${rec.priceMode==='perKg'?(LANG==="sv"?"pris/kg":"per kg"):(LANG==="sv"?"pris/fÃ¶rp":"per pack")}):
               ${LANG==="sv"?"exakt":"exact"} ${exactCost.toFixed(2)}, ${LANG==="sv"?"avrundat":"rounded"} ${roundedCost.toFixed(2)}, ${LANG==="sv"?"rekommenderat":"recommended"} ${recommendedCost.toFixed(2)}</div>
          </div>
        `);
      });
      info.innerHTML = parts.join("");
    }

    /* ================== RENDER ALL ================== */
    function renderAll(){
      areasContainer.innerHTML="";
      state.project.areas.forEach(a=>areasContainer.appendChild(createAreaElement(a)));

      vatToggle.checked=state.project.settings.vatIncluded;
      vatPercentInput.value=state.project.settings.vatRate;
      overageToggle.checked=state.project.settings.overageIncluded;
      overagePercentInput.value=state.project.settings.overagePercent;
      exactToggle.checked=state.project.settings.exactMode||false;
      stepModeToggle.checked=state.project.settings.stepMode||false;
      darkModeToggle.checked=state.project.settings.darkMode||false;
      document.body.classList.toggle("step-on", state.project.settings.stepMode);
      document.body.classList.toggle("dark-mode", state.project.settings.darkMode);

      renderTemplates();
      applyI18n();
      updateCalculations(true);

      // hide top add dock if at least one area exists
      topAddDock.style.display = state.project.areas.length ? "none" : "flex";

      const ud=state.undoStack.at(-1)?.desc || (LANG==="sv"?"Inget att Ã¥ngra":"Nothing to undo");
      const rd=state.redoStack.at(-1)?.desc || (LANG==="sv"?"Inget att gÃ¶ra om":"Nothing to redo");
      undoBtn.title = (LANG==="sv"?"Ã…ngra: ":"Undo: ")+ud;
      redoBtn.title = (LANG==="sv"?"GÃ¶r om: ":"Redo: ")+rd;
      undoBtn.disabled=state.undoStack.length===0;
      redoBtn.disabled=state.redoStack.length===0;
    }

    /* ================== TEMPLATES (bottom) ================== */
    const TKEY="__TEMPLATES__";
    function newTemplate(){ return {id:state.nextTemplateId++,name:"",color:"#6cb2ff",calcMode:"thickness",usagePerM2:0,layers:1,thickness:0,density:null,packSize:1,packUnit:"kg",price:0,priceMode:"perPack",coverSqmPerPack:0,coverLayersPerPack:1}; }
    function getTemplates(){ if(!state._templates) state._templates=[]; return state._templates; }
    function saveTemplates(){ localStorage.setItem(TKEY, JSON.stringify(getTemplates())); }
    function loadTemplates(){ try{ const raw=localStorage.getItem(TKEY); if(raw){const arr=JSON.parse(raw)||[]; state._templates=arr; state.nextTemplateId=(Math.max(0,...arr.map(x=>x.id||0))+1)||1;}}catch{state._templates=[];} }

    function renderTemplates(){
      const templatesBody=document.getElementById("templatesBody");
      templatesBody.innerHTML="";
      const list=getTemplates();
      if(!list.length){ templatesBody.innerHTML=`<div style="color:var(--muted)">${LANG==="sv"?"Inga mallar Ã¤nnu.":"No templates yet."}</div>`; return; }
      list.forEach(t=>{
        const row=el("div",{style:"display:grid;grid-template-columns: 200px 80px 140px 120px 120px 110px 110px 90px 130px 120px 120px 120px auto;gap:8px;align-items:center;margin:6px 0"});
        const n=el("input",{value:t.name,placeholder:t("product")}); row.appendChild(n);
        const color=el("input",{type:"color",value:t.color||"#6cb2ff"}); row.appendChild(color);
        const mode=el("select"); [["thickness",t("calcThickness")],["usage",t("calcUsage")],["coverage",t("calcCoverage")]].forEach(([v,l])=>{const o=el("option",{value:v});o.textContent=l;mode.appendChild(o);}); mode.value=t.calcMode; row.appendChild(mode);
        const use=el("input",{type:"number",min:"0",step:"0.001",value:t.usagePerM2||0}); row.appendChild(use);
        const lay=el("input",{type:"number",min:"1",step:"1",value:t.layers||1}); row.appendChild(lay);
        const th =el("input",{type:"number",min:"0",step:"0.1",value:t.thickness||0}); row.appendChild(th);
        const de =el("input",{type:"number",min:"0",step:"0.01",value:(t.density??"")}); row.appendChild(de);
        const ps =el("input",{type:"number",min:"0.0001",step:"0.1",value:t.packSize||1}); row.appendChild(ps);
        const pu =el("select"); ["kg","L"].forEach(u=>{const o=el("option",{value:u});o.textContent=u; pu.appendChild(o);}); pu.value=t.packUnit||"kg"; row.appendChild(pu);
        const pm =el("select"); [["perPack",t("perPack")],["perKg",t("perKg")]].forEach(([v,l])=>{const o=el("option",{value:v});o.textContent=l;pm.appendChild(o);}); pm.value=t.priceMode||"perPack"; row.appendChild(pm);
        const pr =el("input",{type:"number",min:"0",step:"0.01",value:t.price||0}); row.appendChild(pr);
        const coverS =el("input",{type:"number",min:"0",step:"0.1",value:t.coverSqmPerPack||0,placeholder:t("coverSqm")}); row.appendChild(coverS);
        const coverL =el("input",{type:"number",min:"1",step:"1",value:t.coverLayersPerPack||1,placeholder:t("coverLayers")}); row.appendChild(coverL);

        const actions=el("div",{style:"display:flex;gap:8px;justify-content:flex-end"});
        const applyAll=el("button",{class:"btn"} , t("applyAllTemplates"));
        const applyCurrent=el("button",{class:"btn"}, LANG==="sv"?"AnvÃ¤nd pÃ¥ aktuellt omrÃ¥de":"Apply to current area");
        const del=el("button",{class:"btn",style:"border:1px solid var(--line)"},"Delete");
        actions.appendChild(applyAll); actions.appendChild(applyCurrent); actions.appendChild(del);
        row.appendChild(actions);

        const bind=()=>{ t.name=n.value; t.color=color.value; t.calcMode=mode.value; t.usagePerM2=toPosFloat(use.value,0); t.layers=Math.max(1,parseInt(lay.value)||1); t.thickness=toPosFloat(th.value,0);
          t.density=(de.value===""?null:toPosFloat(de.value,0)); t.packSize=Math.max(0.0001,parseFloat(ps.value)||1); t.packUnit=pu.value; t.price=toPosFloat(pr.value,0); t.priceMode=pm.value;
          t.coverSqmPerPack=toPosFloat(coverS.value,0); t.coverLayersPerPack=Math.max(1,parseInt(coverL.value)||1);
        };
        [n,color,mode,use,lay,th,de,ps,pu,pm,pr,coverS,coverL].forEach(inp=>inp.addEventListener("change",()=>{bind();saveTemplates();}));

        applyAll.addEventListener("click",()=>{
          bind(); saveTemplates();
          pushStateForUndo(`Apply template "${t.name}" to all areas`);
          state.project.areas.forEach(a=>{const np=cloneProductData(t); np.id=state.nextProductId++; a.products.push(np);});
          log(t("tmplApplyAll")); renderAll();
        });
        applyCurrent.addEventListener("click",()=>{
          bind(); saveTemplates();
          const a = state.project.areas[0]; if(!a){alert(LANG==="sv"?"Skapa ett omrÃ¥de fÃ¶rst.":"Create an area first."); return;}
          pushStateForUndo(`Apply template "${t.name}" to first area`);
          const np=cloneProductData(t); np.id=state.nextProductId++; a.products.push(np); renderAll();
        });
        del.addEventListener("click",()=>{
          if(!confirm(LANG==="sv"?"Ta bort mallen?":"Delete this template?")) return;
          const L=getTemplates(); const idx=L.findIndex(x=>x.id===t.id); if(idx>-1){L.splice(idx,1); saveTemplates(); renderTemplates();}
        });

        templatesBody.appendChild(row);
      });
    }

    /* ================== IMPORT / EXPORT ================== */
    function importData(file,content){
      const name=file.name;
      if(name.endsWith(".json")){
        try{
          const parsed=JSON.parse(content);
          if(!parsed.areas||!parsed.settings) throw new Error("Invalid JSON format");
          pushStateForUndo(`Imported JSON (${name})`);
          state.project.areas=parsed.areas; state.project.settings={...state.project.settings,...parsed.settings};
          state.nextAreaId=1; state.nextProductId=1; state.project.areas.forEach(a=>{if(a.id>=state.nextAreaId)state.nextAreaId=a.id+1;a.products.forEach(p=>{if(p.id>=state.nextProductId)state.nextProductId=p.id+1;});});
          renderAll(); log(`Imported JSON "${name}"`);
        }catch(err){ alert("Failed to import JSON: "+err.message); log("Error importing JSON: "+err.message); }
      }else if(name.endsWith(".csv")){
        try{
          const lines=content.split(/\r?\n/).filter(l=>l.trim().length>0); if(!lines.length) throw new Error("Empty CSV");
          let start=0, headers=[]; if(/area\s*name|areaname/i.test(lines[0])){headers=parseCSVLine(lines[0]);start=1;} else headers=["AreaName","SurfaceType","SurfaceMod","AreaSize","ProductName","Color","Layers","Thickness","Density","PackSize","PackUnit","Price","PriceMode","VATIncluded","VATRate","OverageIncluded","OveragePercent","CalcMode","UsagePerM2","CoverSqmPerPack","CoverLayersPerPack"];
          const idx={}; headers.forEach((c,i)=>idx[c]=i);
          const importedAreas=[]; const map={}; let importedSettings={};
          for(let i=start;i<lines.length;i++){
            const v=parseCSVLine(lines[i]); if(!v.length) continue;
            const aName=v[idx["AreaName"]??0]||""; if(!aName) continue;
            const sType=v[idx["SurfaceType"]]||"Custom";
            const sMod =parseFloat(v[idx["SurfaceMod"]])||1.0;
            const aSize=parseFloat(v[idx["AreaSize"]])||0;
            const pName=v[idx["ProductName"]]||"";
            const color=v[idx["Color"]]||null;
            const layers=parseInt(v[idx["Layers"]])||1;
            const thick =parseFloat(v[idx["Thickness"]])||0;
            const dens =(v[idx["Density"]]!=="" && v[idx["Density"]]!=null)? parseFloat(v[idx["Density"]]): null;
            const pSize =parseFloat(v[idx["PackSize"]])||1;
            const pUnit =v[idx["PackUnit"]]||"kg";
            const price =parseFloat(v[idx["Price"]])||0;
            const pMode =v[idx["PriceMode"]]||"perPack";
            const mode  =v[idx["CalcMode"]]||"thickness";
            const usage =parseFloat(v[idx["UsagePerM2"]])||0;
            const covS  =parseFloat(v[idx["CoverSqmPerPack"]])||0;
            const covL  =parseInt(v[idx["CoverLayersPerPack"]])||1;
            if(i===start){
              importedSettings.vatIncluded = /^(true|1)$/i.test(v[idx["VATIncluded"]]||"");
              importedSettings.vatRate     = parseFloat(v[idx["VATRate"]]) || state.project.settings.vatRate;
              importedSettings.overageIncluded = /^(true|1)$/i.test(v[idx["OverageIncluded"]]||"");
              importedSettings.overagePercent  = parseFloat(v[idx["OveragePercent"]]) || state.project.settings.overagePercent;
            }
            let area = map[aName];
            if(!area){ area={id:state.nextAreaId++,name:aName,modifier:sMod,size:aSize,products:[]}; map[aName]=area; importedAreas.push(area); }
            if(pName || price>0 || thick>0){
              area.products.push({
                id:state.nextProductId++, name:pName, color, layers, thickness:thick, density:dens, packSize:pSize, packUnit:pUnit, price, priceMode:pMode,
                calcMode:mode, usagePerM2:usage, coverSqmPerPack:covS, coverLayersPerPack:covL
              });
            }
          }
          pushStateForUndo(`Imported CSV (${name})`);
          state.project.areas=importedAreas; state.project.settings={...state.project.settings,...importedSettings}; renderAll(); log(`Imported CSV "${name}"`);
        }catch(err){ alert("Failed to import CSV: "+err.message); log("Error importing CSV: "+err.message); }
      }else{ alert(t("errUnsupported")); log("Import failed: unsupported file"); }
    }
    function parseCSVLine(line){
      const out=[]; let cur=""; let q=false;
      for(let i=0;i<line.length;i++){
        const ch=line[i];
        if(!q){ if(ch===','){out.push(cur.trim());cur="";} else if(ch==='"'){q=true;} else cur+=ch; }
        else{ if(ch==='"'){ if(i+1<line.length && line[i+1]==='"'){cur+='"'; i++;} else q=false; } else cur+=ch; }
      }
      out.push(cur.trim()); return out;
    }

    function exportJSON(){ const blob=new Blob([JSON.stringify(state.project,null,2)],{type:"application/json"}); downloadBlob(blob,"project_export.json"); log("Exported JSON"); }
    function exportCSV(){
      const headers=["AreaName","SurfaceType","SurfaceMod","AreaSize","ProductName","Color","Layers","Thickness","Density","PackSize","PackUnit","Price","PriceMode","VATIncluded","VATRate","OverageIncluded","OveragePercent","CalcMode","UsagePerM2","CoverSqmPerPack","CoverLayersPerPack"];
      const lines=[headers.join(",")]; const S=state.project.settings;
      state.project.areas.forEach(a=>{
        if(!a.products.length){
          lines.push([a.name, reverseFindTypeByFactor(a.modifier)||"Custom", a.modifier, a.size,"","", "", "", "", "", "", "", "", S.vatIncluded,S.vatRate,S.overageIncluded,S.overagePercent,"","","",""].map(formatCSVValue).join(","));
        }else{
          a.products.forEach(p=>{
            lines.push([a.name, reverseFindTypeByFactor(a.modifier)||"Custom", a.modifier, a.size, p.name||"", p.color||"", p.layers, p.thickness, (p.density!=null?p.density:""), p.packSize, p.packUnit, p.price, p.priceMode||"perPack", S.vatIncluded,S.vatRate,S.overageIncluded,S.overagePercent, p.calcMode, p.usagePerM2, p.coverSqmPerPack, p.coverLayersPerPack].map(formatCSVValue).join(","));
          });
        }
      });
      downloadBlob(new Blob([lines.join("\n")],{type:"text/csv"}),"project_export.csv"); log("Exported CSV");
    }

    function generateExcelXML(){
      const nl="\r\n";
      let xml='<?xml version="1.0"?>'+nl;
      xml+='<?mso-application progid="Excel.Sheet"?>'+nl;
      xml+='<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet" xmlns:html="http://www.w3.org/TR/REC-html40">'+nl;
      xml+='<Styles>'+nl+'<Style ss:ID="Bold"><Font ss:Bold="1"/></Style>'+nl+'<Style ss:ID="TwoDec"><NumberFormat ss:Format="0.00"/></Style>'+nl+'<Style ss:ID="BoldTwoDec"><Font ss:Bold="1"/><NumberFormat ss:Format="0.00"/></Style>'+nl+'</Styles>'+nl;
      xml+='<Worksheet ss:Name="Estimate">'+nl;
      const COLS=20; let rows=1; state.project.areas.forEach(a=>{rows+=a.products.length; rows+=1;}); rows+=1;
      xml+=`<Table ss:ExpandedColumnCount="${COLS}" ss:ExpandedRowCount="${rows}">`+nl;
      for(let j=0;j<COLS;j++){xml+='<Column ss:AutoFitWidth="1"/>'+nl;}
      const headers=["Area","Surface Mod","Area Size (mÂ²)","Product","Color","# Mode","Usage kg/mÂ²","Density kg/L","Pack size","Unit","Price Mode","Price","Cover mÂ²/pack","Cover layers/pack","Layers","Thickness (mm)","Needed","Packages","Cost"];
      xml+='<Row ss:StyleID="Bold">'+nl; headers.forEach(h=>xml+=`<Cell><Data ss:Type="String">${h}</Data></Cell>`+nl); xml+='</Row>'+nl;

      let rowIndex=1, areaTotalRows=[];
      state.project.areas.forEach(a=>{
        a.products.forEach(p=>{
          rowIndex++;
          const S=state.project.settings;
          const areaSize=Number(a.size)||0, layers=Math.max(1,Number(p.layers)||1);
          const unit=p.packUnit||"kg", price=Number(p.price)||0, packSize=Math.max(0.0001,Number(p.packSize)||0), priceMode=p.priceMode||"perPack";
          let needed=0, packages=0;
          if((p.calcMode||"thickness")==="usage"){
            let base= areaSize*layers*(Number(p.usagePerM2)||0); base*=a.modifier; if(S.overageIncluded) base*=(1+S.overagePercent/100);
            needed=base; packages= S.exactMode ? needed/packSize : Math.ceil(needed/packSize);
          }else if(p.calcMode==="thickness"){
            let volL= areaSize*(Number(p.thickness)||0)*layers; volL*=a.modifier; if(S.overageIncluded) volL*=(1+S.overagePercent/100);
            needed = (unit==="kg") ? ((Number(p.density)||0)>0 ? volL*(Number(p.density)||0) : 0) : volL;
            packages= S.exactMode ? needed/packSize : Math.ceil(needed/packSize);
          }else{
            const cov=Number(p.coverSqmPerPack)||0; const covL=Math.max(1,Number(p.coverLayersPerPack)||1);
            const packNeed = cov>0 ? (areaSize * (layers/covL) / cov) : 0;
            packages = S.exactMode ? packNeed : Math.ceil(packNeed);
            needed = packages * packSize;
          }
          const cost=(priceMode==='perKg')?(needed*price):(packages*price);

          xml+='<Row>'+nl;
          xml+=`<Cell><Data ss:Type="String">${escapeXML(a.name)}</Data></Cell>`+nl;
          xml+=`<Cell><Data ss:Type="Number">${a.modifier}</Data></Cell>`+nl;
          xml+=`<Cell><Data ss:Type="Number">${a.size}</Data></Cell>`+nl;
          xml+=`<Cell><Data ss:Type="String">${escapeXML(p.name||"")}</Data></Cell>`+nl;
          xml+=`<Cell><Data ss:Type="String">${escapeXML(p.color||"")}</Data></Cell>`+nl;
          xml+=`<Cell><Data ss:Type="String">${p.calcMode}</Data></Cell>`+nl;
          xml+=`<Cell><Data ss:Type="Number">${p.usagePerM2||0}</Data></Cell>`+nl;
          xml+=`<Cell><Data ss:Type="Number">${(p.density!=null?p.density:"")}</Data></Cell>`+nl;
          xml+=`<Cell><Data ss:Type="Number">${p.packSize||0}</Data></Cell>`+nl;
          xml+=`<Cell><Data ss:Type="String">${unit}</Data></Cell>`+nl;
          xml+=`<Cell><Data ss:Type="String">${priceMode}</Data></Cell>`+nl;
          xml+=`<Cell><Data ss:Type="Number">${price}</Data></Cell>`+nl;
          xml+=`<Cell><Data ss:Type="Number">${p.coverSqmPerPack||0}</Data></Cell>`+nl;
          xml+=`<Cell><Data ss:Type="Number">${p.coverLayersPerPack||1}</Data></Cell>`+nl;
          xml+=`<Cell><Data ss:Type="Number">${layers}</Data></Cell>`+nl;
          xml+=`<Cell><Data ss:Type="Number">${p.thickness||0}</Data></Cell>`+nl;
          xml+=`<Cell><Data ss:Type="Number">${needed.toFixed(1)}</Data></Cell>`+nl;
          xml+=`<Cell><Data ss:Type="Number">${S.exactMode?fmt(packages):packages}</Data></Cell>`+nl;
          xml+=`<Cell ss:StyleID="TwoDec"><Data ss:Type="Number">${cost.toFixed(2)}</Data></Cell>`+nl;
          xml+='</Row>'+nl;
        });
        rowIndex++; areaTotalRows.push(rowIndex);
        let areaTotal=0;
        a.products.forEach(p=>{
          const S=state.project.settings; const areaSize=Number(a.size)||0; const layers=Math.max(1,Number(p.layers)||1);
          const unit=p.packUnit||"kg"; const price=Number(p.price)||0; const packSize=Math.max(0.0001,Number(p.packSize)||0); const priceMode=p.priceMode||"perPack";
          let needed=0, packages=0;
          if((p.calcMode||"thickness")==="usage"){
            let base= areaSize*layers*(Number(p.usagePerM2)||0); base*=a.modifier; if(S.overageIncluded) base*=(1+S.overagePercent/100);
            needed=base; packages= S.exactMode ? needed/packSize : Math.ceil(needed/packSize);
          }else if(p.calcMode==="thickness"){
            let volL= areaSize*(Number(p.thickness)||0)*layers; volL*=a.modifier; if(S.overageIncluded) volL*=(1+S.overagePercent/100);
            needed = (unit==="kg") ? ((Number(p.density)||0)>0 ? volL*(Number(p.density)||0) : 0) : volL;
            packages= S.exactMode ? needed/packSize : Math.ceil(needed/packSize);
          }else{
            const cov=Number(p.coverSqmPerPack)||0; const covL=Math.max(1,Number(p.coverLayersPerPack)||1);
            const packNeed = cov>0 ? (areaSize * (layers/covL) / cov) : 0;
            packages = S.exactMode ? packNeed : Math.ceil(packNeed);
            needed = packages * packSize;
          }
          areaTotal += (priceMode==='perKg')?(needed*price):(packages*price);
        });
        xml+='<Row ss:StyleID="Bold">'+nl;
        xml+=`<Cell ss:MergeAcross="17"><Data ss:Type="String">${escapeXML(a.name)} Total</Data></Cell>`+nl;
        xml+=`<Cell ss:StyleID="BoldTwoDec"><Data ss:Type="Number">${areaTotal.toFixed(2)}</Data></Cell>`+nl;
        xml+='</Row>'+nl;
      });
      rowIndex++;
      xml+='<Row ss:StyleID="Bold">'+nl;
      xml+='<Cell ss:MergeAcross="17"><Data ss:Type="String">Project Total</Data></Cell>'+nl;
      if(areaTotalRows.length){ const refs=areaTotalRows.map(r=>`R${r}C`); xml+=`<Cell ss:StyleID="BoldTwoDec" ss:Formula="=SUM(${refs.join(",")})"><Data ss:Type="Number"></Data></Cell>`+nl; }
      else xml+='<Cell ss:StyleID="BoldTwoDec"><Data ss:Type="Number">0</Data></Cell>'+nl;
      xml+='</Row>'+nl + '</Table>'+nl + '</Worksheet>'+nl + '</Workbook>';
      return xml;
    }
    function exportExcel(){ downloadBlob(new Blob([generateExcelXML()],{type:"application/vnd.ms-excel"}),"project_estimate.xls"); log("Exported Excel"); }

    /* ================== EVENTS ================== */
    // Top add area (hide after first area exists)
    btnAddAreaDock.addEventListener("click",()=>{
      const id=state.nextAreaId++; const nm=(LANG==="sv"?"OmrÃ¥de ":"Area ")+id;
      const a={id,name:nm,modifier:state.project.settings.surfaceTypes["Smooth"],size:0,products:[]};
      state.project.areas.push(a); const el=createAreaElement(a); areasContainer.appendChild(el);
      log(`Added area "${nm}"`); pushStateForUndo(`Added area ${nm}`); updateCalculations();
      el.scrollIntoView({behavior:"smooth",block:"center"});
      topAddDock.style.display="none";
    });
    undoBtn.addEventListener("click",undo); redoBtn.addEventListener("click",redo);

    vatToggle.addEventListener("change",()=>{state.project.settings.vatIncluded=vatToggle.checked; log(`VAT ${vatToggle.checked?"included":"excluded"}`); updateCalculations();});
    vatPercentInput.addEventListener("change",()=>{state.project.settings.vatRate=toPosFloat(vatPercentInput.value,0); log(`VAT ${state.project.settings.vatRate}%`); updateCalculations();});
    overageToggle.addEventListener("change",()=>{state.project.settings.overageIncluded=overageToggle.checked; log(`${overageToggle.checked?"Apply":"Remove"} overage`); updateCalculations();});
    overagePercentInput.addEventListener("change",()=>{state.project.settings.overagePercent=toPosFloat(overagePercentInput.value,0); if(state.project.settings.overageIncluded) updateCalculations();});
    exactToggle.addEventListener("change",()=>{state.project.settings.exactMode=exactToggle.checked; log(`Exact mode ${state.project.settings.exactMode?"ON":"OFF"}`); updateCalculations();});
    darkModeToggle.addEventListener("change",()=>{state.project.settings.darkMode=darkModeToggle.checked; document.body.classList.toggle("dark-mode", state.project.settings.darkMode);});
    stepModeToggle.addEventListener("change",()=>{state.project.settings.stepMode=stepModeToggle.checked; document.body.classList.toggle("step-on", state.project.settings.stepMode); updateCalculations();});

    importBtn.addEventListener("click",()=>fileInput.click());
    fileInput.addEventListener("change",(e)=>{
      const file=e.target.files[0]; if(!file) return; const r=new FileReader();
      r.onload=()=>importData(file,r.result); r.onerror=()=>{alert("Failed to read file"); log("Error reading file");}; r.readAsText(file); fileInput.value="";
    });
    exportJSONBtn.addEventListener("click",exportJSON);
    exportCSVBtn.addEventListener("click",exportCSV);
    exportExcelBtn.addEventListener("click",exportExcel);
    printBtn.addEventListener("click",()=>{window.print(); log("Print/PDF");});

    minimizeLogBtn.addEventListener("click",()=>{if(!logPanel.classList.contains("minimized")) logPanel.classList.add("minimized"); else {logPanel.classList.remove("minimized"); logPanel.classList.remove("maximized");}});
    maximizeLogBtn.addEventListener("click",()=>{if(logPanel.classList.contains("maximized")) logPanel.classList.remove("maximized"); else {logPanel.classList.remove("minimized"); logPanel.classList.add("maximized");}});

    btnScrollSummary.addEventListener("click",()=>{document.getElementById("infoSummary").scrollIntoView({behavior:"smooth"});});

    // Language toggles
    langSV.addEventListener("click",()=>{LANG="sv"; langSV.classList.add("active"); langEN.classList.remove("active"); applyI18n(); renderAll();});
    langEN.addEventListener("click",()=>{LANG="en"; langEN.classList.add("active"); langSV.classList.remove("active"); applyI18n(); renderAll();});

    /* ================== INIT ================== */
    function applyI18n(){document.querySelectorAll("[data-i18n]").forEach(el=>{el.textContent=t(el.getAttribute("data-i18n"));}); refreshSummaryLabels();}
    loadTemplates();
    applyI18n();
    log("App started");
    renderAll();

  })();
  </script>
</body>
</html>
