<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Betongytor â€” Material- & Kostnadsestimator PRO</title>
  <style>
    /* ============ THEME (brighter, improved dark) ============ */
    :root{
      --bg:#f6fbff;
      --fg:#0f172a;
      --muted:#475569;
      --panel:#ffffff;
      --line:#dbe5f0;
      --accent:#2563eb;         /* blue */
      --accent-2:#10b981;       /* green */
      --amber:#f59e0b;          /* amber */
      --danger:#ef4444;
      --shadow:0 10px 24px rgba(2,32,71,.08);
      --chip:#e9f4ff;
      --chip2:#e8fff6;
      --grad:linear-gradient(135deg,#eef6ff 0%,#f2fff8 100%);
      --rowBg:#ffffff;
      --rowAlt:#f9fbff;
      --tooltipBg:#111827;
      --tooltipFg:#f9fafb;
    }
    body.dark-mode{
      --bg:#0b1120;
      --fg:#e5efff;
      --muted:#94a3b8;
      --panel:#0f172a;
      --line:#1e293b;
      --accent:#60a5fa;
      --accent-2:#34d399;
      --amber:#fbbf24;
      --danger:#f87171;
      --shadow:0 10px 24px rgba(0,0,0,.35);
      --chip:#0b1c36;
      --chip2:#062a23;
      --grad:linear-gradient(135deg,#0b1120 0%,#0b1720 100%);
      --rowBg:#0b1427;
      --rowAlt:#0c1a33;
      --tooltipBg:#111827;
      --tooltipFg:#f9fafb;
    }
    html,body{height:100%}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,sans-serif;background:var(--grad);color:var(--fg);margin:0}

    /* ============ TOPBAR ============ */
    .toolbar{
      position:sticky;top:0;z-index:30;
      background:linear-gradient(90deg,var(--panel) 0%,rgba(255,255,255,.6) 100%);
      backdrop-filter:saturate(1.2) blur(6px);
      padding:10px 12px; display:flex; flex-wrap:wrap; gap:10px; align-items:center;
      border-bottom:1px solid var(--line); box-shadow:0 6px 14px rgba(15,23,42,.06);
    }
    .toolbar .group{display:flex;align-items:center;gap:8px;background:var(--panel);border:1px solid var(--line);padding:6px 8px;border-radius:12px}
    .toolbar label{font-weight:600}
    .toolbar input[type="number"]{width:74px}
    .toolbar .grow{flex:1}
    .btn{
      appearance:none;border:0;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:700;letter-spacing:.2px;
      box-shadow:var(--shadow);transition:transform .04s ease,filter .14s ease, background .2s ease, color .2s ease;
    }
    .btn:active{transform:translateY(1px)}
    .btn-primary{background:var(--accent-2);color:#00140c}
    .btn-blue{background:var(--accent);color:#ecfeff}
    .btn-ghost{background:var(--panel);color:var(--fg);border:1px solid var(--line);box-shadow:none}
    .flag-btn{font-size:18px;line-height:1;padding:6px 10px;border-radius:10px;border:1px solid var(--line);background:var(--panel);cursor:pointer}
    .flag-btn.active{outline:2px solid var(--accent);}
    .icon-btn{width:42px;height:42px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px}
    .icon-btn[disabled]{opacity:.45;cursor:not-allowed}

    /* ============ LAYOUT ============ */
    #areasContainer{padding:14px 12px 120px}
    .area{
      background:var(--panel);border:1px solid var(--line);border-radius:16px;margin:16px 6px;padding:12px 12px 10px;
      box-shadow:var(--shadow);
    }
    .area-header{
      display:grid;grid-template-columns: 230px 200px 150px 220px 1fr auto;gap:10px;align-items:center;margin-bottom:10px
    }
    .area-header .pill{background:var(--chip2);color:#065f46;border:1px solid #86efac55;border-radius:999px;padding:5px 10px;font-weight:700}
    .del-area{background:var(--panel);color:#991b1b;border:1px solid #fecaca33;border-radius:10px;padding:8px 10px;cursor:pointer}
    .del-area:hover{background:#ffeff157}
    .add-area-below{
      margin:10px 0 0 0; background:var(--accent-2); color:#00140c; border:0; border-radius:10px; padding:8px 10px; font-weight:700; cursor:pointer
    }

    .unit-wrap{display:flex;align-items:center;gap:6px}
    .unit-wrap input{flex:1;padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:var(--panel);color:var(--fg)}
    .unit-wrap .unit{font-weight:700;color:var(--muted)}

    /* ============ TABLE ============ */
    .area-grid{display:grid;grid-template-columns: minmax(480px,1.7fr) 280px;gap:12px}
    table.area-table{width:100%;border-collapse:separate;border-spacing:0 6px;margin-bottom:6px}
    thead tr th{font-size:.92em;text-transform:uppercase;letter-spacing:.04em;color:var(--muted)}
    table.area-table th,table.area-table td{padding:6px 8px;background:var(--rowBg);border:1px solid var(--line)}
    table.area-table th:first-child,table.area-table td:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
    table.area-table th:last-child,table.area-table td:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
    table.area-table input,table.area-table select{width:100%;box-sizing:border-box;padding:6px 7px;border:1px solid var(--line);border-radius:9px;font:inherit;background:var(--panel);color:var(--fg)}

    /* header groups */
    .th-group{background:var(--rowAlt);font-weight:800;text-align:center;border:1px solid var(--line);padding:6px 4px}

    .drag-handle{cursor:grab;font-size:18px;user-select:none}
    .product-row{position:relative; background:var(--rowBg)}
    .product-row.dragging{opacity:.6}
    /* thinner rows */
    .product-row td{padding:5px 7px}
    /* overlay row actions sitting ON TOP (doesn't change height) */
    .row-actions-overlay{
      position:absolute; top:-10px; right:6px; display:none; gap:6px; z-index:3
    }
    .product-row:hover .row-actions-overlay, .product-row.active .row-actions-overlay{display:flex}
    .mini{font-size:.78em;padding:4px 6px;border-radius:7px;border:1px solid var(--line);background:var(--panel);cursor:pointer}
    .mini.green{border-color:#86efac55;background:#0df15e19;color:#14532d}
    .mini.warn{border-color:#fde68a55;background:#fde68a19;color:#92400e}
    .mini.ghost{border-color:var(--line);color:var(--muted)}
    .mini.danger{border-color:#fecaca55;background:#fecaca22;color:#9f1239}

    /* ============ SIDEBAR ============ */
    .area-side{display:flex;flex-direction:column;gap:10px}
    .canvas-wrap{border:1px solid var(--line);background:var(--panel);border-radius:14px;padding:8px}
    .canvas-wrap header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .canvas-wrap small{color:var(--muted)}
    .canvas-wrap canvas{width:100%;height:110px;border-radius:10px;background:var(--panel)}
    .infobox{border:1px dashed #93c5fd66;background:#e0f2fe14;padding:10px;border-radius:10px;font-size:.95em}
    .infobox h4{margin:0 0 6px 0}
    .infobox .note{color:#1e3a8a}

    /* ============ SUMMARY BOX ============ */
    .project-summary{margin:16px;font-size:1.1em;font-weight:800}
    #infoSummary{margin:14px;background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow)}
    #infoSummary header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--line);padding:10px 12px}
    #infoSummary .body{padding:10px 12px}
    .product-total{border:1px solid var(--line);border-radius:12px;padding:10px;margin:8px 0;background:var(--rowAlt)}
    .product-total h5{margin:0 0 4px 0}
    .product-total .dim{color:var(--muted)}

    /* ============ FLOAT INFO TOAST ============ */
    #infoToast{
      position:fixed;right:16px;bottom:74px;background:var(--tooltipBg);color:var(--tooltipFg);padding:10px 12px;border-radius:999px;
      cursor:pointer;display:none;align-items:center;gap:8px;box-shadow:var(--shadow);z-index:40
    }
    #infoToast .dot{width:8px;height:8px;border-radius:50%;background:#22c55e}

    /* ============ LOGS ============ */
    #logPanel{position:fixed;bottom:0;left:0;right:0;background:#0b1220;color:#e5e7eb;font-family:ui-monospace,Consolas,monospace;font-size:.9em;max-height:230px;display:flex;flex-direction:column;border-top:2px solid #1f2937;z-index:35}
    body:not(.dark-mode) #logPanel{background:#0b1220}
    #logHeader{background:#0f172a;padding:6px 8px;font-weight:800;display:flex;align-items:center;gap:8px}
    #logHeader .sp{flex:1}
    #logHeader button{background:#1f2937;color:#fff;border:none;padding:4px 8px;margin-left:5px;cursor:pointer;font-weight:bold;border-radius:8px}
    #logContent{overflow-y:auto;padding:6px}
    #logPanel.minimized{max-height:none;height:auto}
    #logPanel.minimized #logContent{display:none}
    #logPanel.maximized{max-height:65vh}

    /* ============ TOOLTIP ============ */
    #hoverTip{
      position:fixed; pointer-events:none; z-index:50; display:none; max-width:320px;
      background:var(--tooltipBg); color:var(--tooltipFg); padding:8px 10px; border-radius:10px; font-size:.9em; box-shadow:var(--shadow)
    }

    /* ============ PRINT ============ */
    @media print{
      .toolbar,#logPanel,#infoToast,#hoverTip{display:none!important}
      .area,.project-summary{border:none;margin:0;page-break-inside:avoid}
      .del-area,.row-actions-overlay,.drag-handle{display:none!important}
    }
  </style>
</head>
<body>
  <!-- ============ TOP MENU ============ -->
  <div class="toolbar" id="toolbar">
    <button id="btnAddAreaTop" class="btn btn-primary" data-i18n="addArea">+ LÃ¤gg till omrÃ¥de</button>

    <!-- Undo / Redo icons with dynamic tooltips -->
    <button id="undo" class="btn btn-ghost icon-btn" disabled title="Undo"><span aria-hidden="true">â†¶</span></button>
    <button id="redo" class="btn btn-ghost icon-btn" disabled title="Redo"><span aria-hidden="true">â†·</span></button>

    <div class="group">
      <strong data-i18n="language">SprÃ¥k</strong>
      <button id="langSV" class="flag-btn active" title="Svenska">ðŸ‡¸ðŸ‡ª</button>
      <button id="langEN" class="flag-btn" title="English">ðŸ‡¬ðŸ‡§</button>
    </div>

    <div class="group">
      <span data-i18n="vat">Moms</span>
      <label for="vatToggle" data-i18n="include">inkludera</label><input type="checkbox" id="vatToggle"/>
      <input type="number" id="vatPercent" value="25" step="1"/>%
    </div>
    <div class="group">
      <span data-i18n="overage">Spill</span>
      <label for="overageToggle" data-i18n="apply">anvÃ¤nd</label><input type="checkbox" id="overageToggle"/>
      <input type="number" id="overagePercent" value="10" step="1"/>%
    </div>
    <div class="group">
      <label for="exactToggle" data-i18n="exact">Exakt berÃ¤kning (ingen avrundning)</label>
      <input type="checkbox" id="exactToggle"/>
    </div>
    <div class="group">
      <label for="darkModeToggle" data-i18n="dark">MÃ¶rkt lÃ¤ge</label><input type="checkbox" id="darkModeToggle"/>
      <label for="stepModeToggle" data-i18n="step">Steg-fÃ¶r-steg</label><input type="checkbox" id="stepModeToggle"/>
    </div>

    <div class="grow"></div>

    <div class="group">
      <button id="importData" class="btn btn-ghost" data-i18n="import">Importera</button>
      <input type="file" id="fileInput" accept=".json,.csv,.xls,.xlsx" style="display:none"/>
      <button id="exportJSON" class="btn btn-ghost" data-i18n="exportJSON">Export JSON</button>
      <button id="exportCSV" class="btn btn-ghost" data-i18n="exportCSV">Export CSV</button>
      <button id="exportExcel" class="btn btn-blue" data-i18n="exportExcel">Export Excel</button>
      <button id="printBtn" class="btn btn-ghost" data-i18n="print">Skriv ut / PDF</button>
    </div>
  </div>

  <!-- ============ AREAS ============ -->
  <div id="areasContainer"></div>

  <!-- ============ SUMMARY ============ -->
  <div class="project-summary" id="projectSummary">Projektets totalsumma (exkl. moms): 0</div>

  <section id="infoSummary">
    <header>
      <strong data-i18n="infoTitle">Info & summeringar</strong>
      <small id="lastInfoTime" style="color:var(--muted)"></small>
    </header>
    <div class="body" id="infoBody"><em data-i18n="infoEmpty">Ingen info Ã¤nnu. LÃ¤gg till produkter och ytor.</em></div>
  </section>

  <!-- ============ GLOBAL TEMPLATES (moved to bottom) ============ -->
  <section id="globalProducts" style="margin:14px;background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow)">
    <header style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--line);padding:10px 12px">
      <strong data-i18n="templatesTitle">Globala Produktmallar</strong>
      <div class="template-actions" style="display:flex;gap:8px">
        <button id="addTemplate" class="btn btn-primary" data-i18n="addTemplate">+ LÃ¤gg till mall</button>
        <button id="applyAllTemplates" class="btn btn-ghost" data-i18n="applyAllTemplates">AnvÃ¤nd ALLA pÃ¥ ALLA omrÃ¥den</button>
      </div>
    </header>
    <div class="body" id="templatesBody" style="padding:10px 12px"></div>
  </section>

  <!-- ============ FLOAT TOAST ============ -->
  <div id="infoToast" title="Visa info">
    <span class="dot"></span><span data-i18n="toast">Info uppdaterad â€” Visa</span>
  </div>

  <!-- ============ HOVER TOOLTIP ============ -->
  <div id="hoverTip"></div>

  <!-- ============ LOGS ============ -->
  <div id="logPanel" class="minimized">
    <div id="logHeader">LOGGAR<span class="sp"></span>
      <button id="minimizeLog">_</button><button id="maximizeLog">&#9723;</button>
    </div>
    <div id="logContent"></div>
  </div>

  <script>
  (()=>{"use strict";

    /* ================== I18N ================== */
    const i18n = {
      sv:{
        addArea:"+ LÃ¤gg till omrÃ¥de", addAreaBelow:"+ LÃ¤gg till omrÃ¥de under",
        undoText:"Ã…ngra", redoText:"GÃ¶r om",
        language:"SprÃ¥k", vat:"Moms", include:"inkludera", overage:"Spill", apply:"anvÃ¤nd",
        exact:"Exakt berÃ¤kning (ingen avrundning)", dark:"MÃ¶rkt lÃ¤ge", step:"Steg-fÃ¶r-steg",
        import:"Importera", exportJSON:"Export JSON", exportCSV:"Export CSV", exportExcel:"Export Excel", print:"Skriv ut / PDF",
        templatesTitle:"Globala Produktmallar", addTemplate:"+ LÃ¤gg till mall", applyAllTemplates:"AnvÃ¤nd ALLA pÃ¥ ALLA omrÃ¥den",
        infoTitle:"Info & summeringar", infoEmpty:"Ingen info Ã¤nnu. LÃ¤gg till produkter och ytor.", toast:"Info uppdaterad â€” Visa",
        areaName:"OmrÃ¥desnamn", surface:"Yttyp", factor:"Faktor", size:"Storlek", sq:"mÂ²",
        areaIllustration:"Illustration", layersLegend:"Lager (fÃ¤rgkodade)",
        product:"Produkt", calc:"LÃ¤ge", usage:"Ã…tgÃ¥ng (per mÂ²/lager)", layers:"Lager", thickness:"Tjocklek (mm)", density:"Densitet (kg/L)",
        packSize:"FÃ¶rp. storlek", unit:"Enhet", pricePack:"Pris/fÃ¶rp", needed:"Behov", packages:"FÃ¶rp", cost:"Kostnad",
        addProduct:"+ LÃ¤gg till produktlager",
        calcThickness:"Tjocklek", calcUsage:"Ã…tgÃ¥ng/mÂ²", calcCoverage:"TÃ¤ckning/fÃ¶rp",
        coverSqm:"TÃ¤ckning (mÂ²/fÃ¶rp)", coverLayers:"Lager per fÃ¶rp",
        prodInfo:"Produktdata", projectInfo:"Projekt/OmrÃ¥desdata",
        deleteArea:"Ta bort omrÃ¥de",
        cloneAll:"Klona â†’ Alla", cloneBelow:"Klona â†“ Nedan", breakdown:"â„¹ Breakdown", remove:"Ta bort",
        hoverSurface:"Yta", hoverProduct:"Produkt",
        tmplAdded:"Mall tillagd", tmplApplyAll:"Mall applicerad pÃ¥ alla omrÃ¥den",
        errUnsupported:"Filformatet stÃ¶ds inte.",
        warnInconsistent:"Avvikelse i CSV fÃ¶r omrÃ¥det",
        updated:"Uppdaterad "
      },
      en:{
        addArea:"+ Add Area", addAreaBelow:"+ Add Area Below",
        undoText:"Undo", redoText:"Redo",
        language:"Language", vat:"VAT", include:"include", overage:"Overage", apply:"apply",
        exact:"Exact calc (no rounding)", dark:"Dark mode", step:"Step-by-step",
        import:"Import", exportJSON:"Export JSON", exportCSV:"Export CSV", exportExcel:"Export Excel", print:"Print / PDF",
        templatesTitle:"Global Product Templates", addTemplate:"+ Add Template", applyAllTemplates:"Apply ALL to ALL Areas",
        infoTitle:"Info & summaries", infoEmpty:"No info yet. Add products and areas.", toast:"Info updated â€” View",
        areaName:"Area name", surface:"Surface", factor:"Factor", size:"Size", sq:"mÂ²",
        areaIllustration:"Illustration", layersLegend:"Layers (color-coded)",
        product:"Product", calc:"Mode", usage:"Usage (per mÂ²/layer)", layers:"Layers", thickness:"Thickness (mm)", density:"Density (kg/L)",
        packSize:"Pack size", unit:"Unit", pricePack:"Price/Pack", needed:"Needed", packages:"Packages", cost:"Cost",
        addProduct:"+ Add Product Layer",
        calcThickness:"Thickness", calcUsage:"Usage/mÂ²", calcCoverage:"Coverage/pack",
        coverSqm:"Coverage (mÂ²/pack)", coverLayers:"Layers per pack",
        prodInfo:"Product info", projectInfo:"Project/Area info",
        deleteArea:"Delete Area",
        cloneAll:"Clone â†’ All", cloneBelow:"Clone â†“ Below", breakdown:"â„¹ Breakdown", remove:"Remove",
        hoverSurface:"Surface", hoverProduct:"Product",
        tmplAdded:"Template added", tmplApplyAll:"Template applied to all areas",
        errUnsupported:"Unsupported file format.",
        warnInconsistent:"Inconsistent CSV data for area",
        updated:"Updated "
      }
    };
    let LANG="sv";
    function t(key){ return (i18n[LANG]&&i18n[LANG][key]) || key; }
    function applyI18n(){
      document.querySelectorAll("[data-i18n]").forEach(el=>{
        const k=el.getAttribute("data-i18n"); el.textContent=t(k);
      });
      refreshSummaryLabel();
    }

    /* ================== STATE ================== */
    const state={
      project:{
        areas:[],
        settings:{
          vatIncluded:false, vatRate:25,
          overageIncluded:false, overagePercent:10,
          exactMode:false, stepMode:false, darkMode:false,
          surfaceTypes:{
            "Smooth":1.00,
            "Light Grind":1.05,
            "Medium Grind":1.10,
            "Rough":1.15,
            "Porous/Cracked":1.25
          },
          surfaceInfo:{
            "Smooth":{title:"Smooth / polished",desc:"Closed pores; dense, burnished surface.",hint:"+0%", prep:"Light cleaning; dust-free", typical:"Troweled/Polished slab"},
            "Light Grind":{title:"Lightly ground",desc:"Micro texture opens; slightly higher uptake.",hint:"+5%", prep:"Degrease + light grind", typical:"Polished with light hone"},
            "Medium Grind":{title:"Medium ground",desc:"Visible sand; micro-cracks possible.",hint:"+10%", prep:"Grinding P80â€“P120", typical:"Traffic-worn interior"},
            "Rough":{title:"Rough / broomed",desc:"Coarse profile; high absorption.",hint:"+15%", prep:"Grinding + vacuum; repair spalls", typical:"Exterior broom finish"},
            "Porous/Cracked":{title:"Highly porous / cracked",desc:"Capillaries & voids; very high absorption.",hint:"+25%", prep:"Crack injection + primer", typical:"Old slab, freeze-thaw damage"},
            "Custom":{title:"Custom",desc:"User-defined surface factor.",hint:"depends", prep:"â€”", typical:"â€”"}
          }
        }
      },
      undoStack:[], redoStack:[],
      nextAreaId:1, nextProductId:1, nextTemplateId:1,
      lastAddedProductTemplate:null
    };

    /* ================== DOM ================== */
    const areasContainer=document.getElementById("areasContainer");
    const projectSummaryEl=document.getElementById("projectSummary");

    const btnAddAreaTop=document.getElementById("btnAddAreaTop");
    const undoBtn=document.getElementById("undo"), redoBtn=document.getElementById("redo");
    const vatToggle=document.getElementById("vatToggle"), vatPercentInput=document.getElementById("vatPercent");
    const overageToggle=document.getElementById("overageToggle"), overagePercentInput=document.getElementById("overagePercent");
    const exactToggle=document.getElementById("exactToggle");
    const darkModeToggle=document.getElementById("darkModeToggle");
    const stepModeToggle=document.getElementById("stepModeToggle");

    const importBtn=document.getElementById("importData"), fileInput=document.getElementById("fileInput");
    const exportJSONBtn=document.getElementById("exportJSON"), exportCSVBtn=document.getElementById("exportCSV"), exportExcelBtn=document.getElementById("exportExcel");
    const printBtn=document.getElementById("printBtn");

    const templatesBody=document.getElementById("templatesBody");
    const addTemplateBtn=document.getElementById("addTemplate");
    const applyAllTemplatesBtn=document.getElementById("applyAllTemplates");

    const infoToast=document.getElementById("infoToast");
    const infoBody=document.getElementById("infoBody");
    const lastInfoTime=document.getElementById("lastInfoTime");

    const logPanel=document.getElementById("logPanel");
    const logContent=document.getElementById("logContent");
    const minimizeLogBtn=document.getElementById("minimizeLog");
    const maximizeLogBtn=document.getElementById("maximizeLog");

    const langSV=document.getElementById("langSV");
    const langEN=document.getElementById("langEN");

    const hoverTip=document.getElementById("hoverTip");

    /* ================== UTIL & LOG ================== */
    function log(msg){
      const tms=new Date().toLocaleTimeString();
      const p=document.createElement("p"); p.textContent=`[${tms}] ${msg}`; logContent.appendChild(p);
      if(logContent.scrollHeight-logContent.clientHeight-logContent.scrollTop<5){logContent.scrollTop=logContent.scrollHeight;}
      // update undo/redo titles
      const ud=state.undoStack.at(-1)?.desc || (LANG==="sv"?"Inget att Ã¥ngra":"Nothing to undo");
      const rd=state.redoStack.at(-1)?.desc || (LANG==="sv"?"Inget att gÃ¶ra om":"Nothing to redo");
      undoBtn.title = (LANG==="sv"?"Ã…ngra: ":"Undo: ")+ud;
      redoBtn.title = (LANG==="sv"?"GÃ¶r om: ":"Redo: ")+rd;
    }
    function pushStateForUndo(desc){
      const snap=JSON.parse(JSON.stringify(state.project));
      state.undoStack.push({data:snap,desc}); state.redoStack.length=0;
      undoBtn.disabled=state.undoStack.length===0; redoBtn.disabled=true;
      undoBtn.title=(LANG==="sv"?"Ã…ngra: ":"Undo: ")+desc;
      redoBtn.title=(LANG==="sv"?"GÃ¶r om: ":"Redo: ");
    }
    function undo(){
      if(!state.undoStack.length) return;
      const last=state.undoStack.pop(); const desc=last.desc;
      state.redoStack.push({data:JSON.parse(JSON.stringify(state.project)),desc});
      state.project=last.data; renderAll(); log(`Undo: ${desc}`);
      undoBtn.disabled=state.undoStack.length===0; redoBtn.disabled=state.redoStack.length===0;
    }
    function redo(){
      if(!state.redoStack.length) return;
      const last=state.redoStack.pop(); const desc=last.desc;
      state.undoStack.push({data:JSON.parse(JSON.stringify(state.project)),desc});
      state.project=last.data; renderAll(); log(`Redo: ${desc}`);
      undoBtn.disabled=state.undoStack.length===0; redoBtn.disabled=state.redoStack.length===0;
    }
    function toPosFloat(v,def){const n=parseFloat(v); return (isNaN(n)||n<0)? def : n;}
    function fmt(n){ if(!isFinite(n)) return "0"; if(Math.abs(n)>=1000) return n.toFixed(0); if(Math.abs(n)>=10) return n.toFixed(1); return n.toFixed(2); }
    function downloadBlob(blob,filename){const url=URL.createObjectURL(blob);const a=document.createElement("a");a.href=url;a.download=filename;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);}
    function formatCSVValue(v){const s=String(v);return /[",\n]/.test(s)?`"${s.replace(/"/g,'""')}"`:s;}
    function escapeXML(s){if(s==null) return ""; return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");}
    const showInfoToast=(()=>{let hide=null;return()=>{infoToast.style.display="flex"; if(hide) clearTimeout(hide); hide=setTimeout(()=>infoToast.style.display="none",3500);};})();

    /* ================== SURFACE INFO ================== */
    function reverseFindTypeByFactor(f){
      const m=Object.entries(state.project.settings.surfaceTypes).find(([_,v])=>Math.abs(v-f)<1e-6);
      return m?m[0]:null;
    }
    function surfaceExpl(area){
      const k = reverseFindTypeByFactor(area.modifier)||"Custom";
      const meta=state.project.settings.surfaceInfo[k] || state.project.settings.surfaceInfo["Custom"];
      return {type:k,title:meta.title,desc:meta.desc,hint:meta.hint,prep:meta.prep,typical:meta.typical,factor:area.modifier.toFixed(2)};
    }

    /* ================== CANVAS ILLUSTRATION ================== */
    function colorFromName(name){let h=0;for(let i=0;i<name.length;i++){h=(h*31+name.charCodeAt(i))>>>0;}return `hsl(${h%360} 70% 55%)`;}
    function baseConcreteColor(area){
      const f=area.modifier; const l = 88 - Math.min(25,(f-1)*60);
      return `hsl(215 14% ${l}%)`;
    }
    function drawAreaIllustration(canvas, area, hoverIdx=-1, hoverSlab=false){
      const ctx=canvas.getContext("2d");
      const W=canvas.width=canvas.clientWidth, H=canvas.height=canvas.clientHeight;
      ctx.clearRect(0,0,W,H);
      // ground slab
      const slabH=26; const slabY=H-slabH; ctx.fillStyle=baseConcreteColor(area);
      ctx.fillRect(0,slabY,W,slabH);
      ctx.strokeStyle="rgba(0,0,0,.08)"; ctx.beginPath(); for(let x=0;x<W;x+=12){ctx.moveTo(x,slabY);ctx.lineTo(x+6,slabY+6);} ctx.stroke();
      // store slab rect
      canvas._slabRect={x:0,y:slabY,w:W,h:slabH};

      // layers
      const totalLayers = area.products.reduce((a,p)=>a+Math.max(1,Number(p.layers||1)),0)||1;
      const space = H-slabH-12;
      const gap=2, unitH=(space - gap*(totalLayers-1))/Math.max(1,totalLayers);
      const rects=[]; let y=H-slabH-gap;

      area.products.forEach(p=>{
        const L=Math.max(1,Number(p.layers||1));
        for(let i=0;i<L;i++){
          const h=unitH;
          const top = y - h;
          const col=colorFromName(p.name||"Layer");
          ctx.fillStyle=col;
          ctx.globalAlpha = (hoverSlab?0.85:1);
          if(rects.length===hoverIdx){ ctx.filter="brightness(1.2)"; }
          else ctx.filter="none";
          ctx.fillRect(8,top,W-16,h);
          ctx.filter="none"; ctx.globalAlpha=1;
          ctx.strokeStyle="rgba(0,0,0,.15)"; ctx.strokeRect(8,top,W-16,h);
          rects.push({x:8,y:top,w:W-16,h, product:p});
          y = top - gap;
        }
      });
      canvas._layerRects = rects;
    }
    function attachCanvasInteractions(canvas, area){
      const tip=hoverTip;
      const show=(html,x,y)=>{tip.innerHTML=html; tip.style.display="block"; const pad=12; tip.style.left=(x+pad)+"px"; tip.style.top=(y+pad)+"px";}
      const hide=()=>{tip.style.display="none";}
      canvas.addEventListener("mousemove",(e)=>{
        const r=canvas.getBoundingClientRect(); const x=e.clientX-r.left, y=e.clientY-r.top;
        const rects=canvas._layerRects||[]; let idx=-1;
        for(let i=0;i<rects.length;i++){const L=rects[i]; if(x>=L.x&&x<=L.x+L.w&&y>=L.y&&y<=L.y+L.h){idx=i; break;}}
        const slab=canvas._slabRect; const onSlab = slab && x>=slab.x && x<=slab.x+slab.w && y>=slab.y && y<=slab.y+slab.h;
        drawAreaIllustration(canvas,area,idx,onSlab);
        if(idx>-1){
          const p=rects[idx].product;
          const html = `<div><strong>${t("hoverProduct")}:</strong> ${p.name||"-"}</div>
            <div>â€¢ ${t("layers")}: ${p.layers||1} â€¢ ${t("thickness")}: ${p.thickness||0} mm</div>
            <div>â€¢ ${t("unit")}: ${p.packUnit||"kg"} â€¢ ${t("packSize")}: ${p.packSize||0}</div>
            <div>â€¢ ${t("pricePack")}: ${p.price||0}</div>`;
          show(html,e.clientX,e.clientY);
        }else if(onSlab){
          const meta=surfaceExpl(area);
          const html = `<div><strong>${t("hoverSurface")}:</strong> ${meta.title} (Ã—${meta.factor})</div>
            <div>${meta.desc}</div>
            <div><em>${LANG==="sv"?"FÃ¶rberedelse":"Prep"}:</em> ${meta.prep}</div>
            <div><em>${LANG==="sv"?"Typiskt":"Typical"}:</em> ${meta.typical}</div>`;
          show(html,e.clientX,e.clientY);
        }else hide();
      });
      canvas.addEventListener("mouseleave",()=>{drawAreaIllustration(canvas,area,-1,false); hoverTip.style.display="none";});
    }

    /* ================== HELPERS ================== */
    function el(tag,attrs={},txt){const e=document.createElement(tag);Object.entries(attrs).forEach(([k,v])=>{if(k==="class")e.className=v;else if(k==="style")e.setAttribute("style",v);else e.setAttribute(k,v);});if(txt!=null)e.textContent=txt;return e;}
    function cloneProductData(prod){
      return JSON.parse(JSON.stringify({
        name:prod.name||"", layers:prod.layers||1, thickness:prod.thickness||0,
        density:(prod.density===null?null:prod.density||0), packSize:prod.packSize||1,
        packUnit:prod.packUnit||"kg", price:prod.price||0,
        calcMode: prod.calcMode || "thickness",
        usagePerM2: prod.usagePerM2 || 0,
        coverSqmPerPack: prod.coverSqmPerPack || 0,
        coverLayersPerPack: prod.coverLayersPerPack || 1
      }));
    }

    /* ================== AREA UI ================== */
    function createAreaElement(area){
      const wrap=el("div",{class:"area","data-area-id":area.id});

      // header
      const header=el("div",{class:"area-header"});

      const nameI=el("input",{type:"text",value:area.name,placeholder:t("areaName")});
      nameI.addEventListener("change",()=>{const old=area.name; area.name=nameI.value; log(`Renamed area "${old}" â†’ "${area.name}"`);});
      header.appendChild(nameI);

      const surfaceSel=el("select");
      Object.keys(state.project.settings.surfaceTypes).concat(["Custom"]).forEach(n=>{
        const o=el("option",{value:n}); o.textContent=n; surfaceSel.appendChild(o);
      });
      const matched=reverseFindTypeByFactor(area.modifier)||"Custom"; surfaceSel.value=matched;
      header.appendChild(surfaceSel);

      const modI=el("input",{type:"number",step:"0.01",value:area.modifier}); modI.disabled=(matched!=="Custom");
      header.appendChild(modI);

      const sizeWrap=el("div",{class:"unit-wrap"});
      const sizeI=el("input",{type:"number",min:"0",step:"0.1",value:area.size||0,placeholder:t("size")});
      const unit=el("div",{class:"unit"},t("sq"));
      sizeWrap.appendChild(sizeI); sizeWrap.appendChild(unit); header.appendChild(sizeWrap);

      const tip=el("div",{class:"pill"}, t("prodInfo")+" / "+t("projectInfo"));
      header.appendChild(tip);

      const del=el("button",{class:"del-area",title:t("deleteArea")}, t("deleteArea"));
      del.addEventListener("click",()=>removeArea(wrap));
      header.appendChild(del);

      wrap.appendChild(header);

      // grid
      const grid=el("div",{class:"area-grid"});

      // table with header groups
      const table=el("table",{class:"area-table", "data-area-id":area.id});
      const thead=el("thead");

      const grp=el("tr");
      grp.appendChild(el("th",{class:"th-group",colspan:"6"},t("prodInfo")));   // product info columns
      grp.appendChild(el("th",{class:"th-group",colspan:"7"},t("projectInfo"))); // project/area calculation columns
      thead.appendChild(grp);

      const head=el("tr");
      ["",t("product"),t("calc"),t("usage"),t("coverSqm"),t("coverLayers"),
       t("layers"),t("thickness"),t("density"),t("packSize"),t("unit"),t("pricePack"),
       t("needed"),t("packages"),t("cost")].forEach(h=>head.appendChild(el("th",{},h)));
      thead.appendChild(head);
      table.appendChild(thead);

      const tbody=el("tbody");
      tbody.setAttribute("data-area-id", area.id);
      area.products.forEach((p)=>tbody.appendChild(buildProductRow(area,p)));
      table.appendChild(tbody);

      // right side: illustration + infobox
      const side=el("div",{class:"area-side"});
      const canvBox=el("div",{class:"canvas-wrap"});
      const canvHdr=el("header");
      canvHdr.appendChild(el("strong",{},t("areaIllustration")));
      canvHdr.appendChild(el("small",{},t("layersLegend")));
      canvBox.appendChild(canvHdr);
      const canvas=document.createElement("canvas"); canvBox.appendChild(canvas);
      side.appendChild(canvBox);

      const info=el("div",{class:"infobox"});
      info.appendChild(el("h4",{},"Surface / Ã…tgÃ¥ng"));
      info.appendChild(el("div",{class:"note","data-bind":"infotext"}));
      side.appendChild(info);

      grid.appendChild(table);
      grid.appendChild(side);
      wrap.appendChild(grid);

      // "Add product" + "Add area below"
      const rowBtnWrap=el("div",{style:"display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 0"});
      const addProdBtn=el("button",{class:"btn btn-primary"}, t("addProduct"));
      addProdBtn.addEventListener("click",()=>{
        const firstAdd = area.products.length===0 && state.lastAddedProductTemplate;
        const frag = addProduct(area,tbody);
        if(firstAdd){
          if(confirm(`Clone last product "${state.lastAddedProductTemplate.name}" to this area?`)){
            applyProductDataToRow(area,frag,state.lastAddedProductTemplate);
            log(`Cloned last product template to "${area.name}"`);
            updateCalculations(true);
          }
        }
      });
      const addAreaBelow=el("button",{class:"add-area-below"}, t("addAreaBelow"));
      addAreaBelow.addEventListener("click",()=>insertAreaBelow(area.id));
      rowBtnWrap.appendChild(addProdBtn);
      rowBtnWrap.appendChild(addAreaBelow);
      wrap.appendChild(rowBtnWrap);

      // listeners
      surfaceSel.addEventListener("change",()=>{
        if(surfaceSel.value==="Custom"){ modI.disabled=false; }
        else{
          area.modifier=state.project.settings.surfaceTypes[surfaceSel.value];
          modI.value=area.modifier; modI.disabled=true;
          log(`Surface "${area.name}" â†’ ${surfaceSel.value} (x${area.modifier})`);
          updateCalculations(true);
        }
        updateAreaInfoboxAndCanvas();
      });
      modI.addEventListener("change",()=>{
        const v=toPosFloat(modI.value,1.0); modI.value=v; area.modifier=v;
        surfaceSel.value = reverseFindTypeByFactor(v) || "Custom";
        if(surfaceSel.value!=="Custom"){ modI.disabled=true; }
        log(`Surface factor "${area.name}" â†’ ${v}`);
        updateCalculations(true); updateAreaInfoboxAndCanvas();
      });
      sizeI.addEventListener("change",()=>{
        const v=toPosFloat(sizeI.value,0); sizeI.value=v; area.size=v; log(`Area size "${area.name}" â†’ ${v} mÂ²`);
        updateCalculations();
      });

      function updateAreaInfoboxAndCanvas(){
        const meta=surfaceExpl(area);
        const note=wrap.querySelector('[data-bind="infotext"]');
        if(note){
          note.innerHTML = `
            <div><strong>${LANG==="sv"?"Typ":"Type"}:</strong> ${meta.title} <span style="color:var(--muted)">(${meta.type})</span></div>
            <div><strong>${t("factor")}:</strong> Ã—${meta.factor} &nbsp; <em>${meta.hint}</em></div>
            <div style="margin-top:4px">${meta.desc}</div>
            <div style="margin-top:6px"><small>${LANG==="sv"?"FÃ¶rberedelse":"Prep"}: ${meta.prep} â€¢ ${LANG==="sv"?"Typiskt":"Typical"}: ${meta.typical}</small></div>
          `;
        }
        drawAreaIllustration(canvas,area);
        attachCanvasInteractions(canvas,area);
      }
      updateAreaInfoboxAndCanvas();

      // drag & drop sorting (tbody)
      enableDragSort(tbody, area);

      return wrap;
    }

    function buildProductRow(area,product){
      if(!product.calcMode) product.calcMode="thickness";
      if(product.usagePerM2==null) product.usagePerM2=0;
      if(product.coverSqmPerPack==null) product.coverSqmPerPack=0;
      if(product.coverLayersPerPack==null||product.coverLayersPerPack<=0) product.coverLayersPerPack=1;

      const tr=el("tr",{class:"product-row","data-product-id":product.id, draggable:"true"});
      tr.addEventListener("click",()=>{tr.classList.add("active"); tr.parentElement.querySelectorAll(".product-row").forEach(r=>{if(r!==tr) r.classList.remove("active");});});

      const td=(child)=>{const c=document.createElement("td"); c.appendChild(child); return c;};

      const drag=el("span",{class:"drag-handle",title:"Drag to reorder"}, "â˜°");
      tr.appendChild(td(drag));

      const nameI=el("input",{type:"text",value:product.name,placeholder:t("product")});
      nameI.addEventListener("change",()=>{product.name=nameI.value; state.lastAddedProductTemplate=cloneProductData(product); log(`Renamed product ${product.id} in "${area.name}" â†’ "${product.name}"`);});
      tr.appendChild(td(nameI));

      const mode=el("select");
      [["thickness",t("calcThickness")],["usage",t("calcUsage")],["coverage",t("calcCoverage")]]
        .forEach(([v,l])=>{const o=el("option",{value:v});o.textContent=l;mode.appendChild(o);});
      mode.value=product.calcMode;
      tr.appendChild(td(mode));

      const usageI=el("input",{type:"number",min:"0",step:"0.001",value:product.usagePerM2||0}); tr.appendChild(td(usageI));
      const coverSqmI=el("input",{type:"number",min:"0",step:"0.01",value:product.coverSqmPerPack||0}); tr.appendChild(td(coverSqmI));
      const coverLayersI=el("input",{type:"number",min:"1",step:"1",value:product.coverLayersPerPack||1}); tr.appendChild(td(coverLayersI));

      const layersI=el("input",{type:"number",min:"1",step:"1",value:product.layers||1});
      layersI.addEventListener("change",()=>{product.layers=Math.max(1,parseInt(layersI.value)||1); layersI.value=product.layers; log(`Layers "${product.name}" in "${area.name}" â†’ ${product.layers}`); updateCalculations();});
      tr.appendChild(td(layersI));

      const thickI=el("input",{type:"number",min:"0",step:"0.1",value:product.thickness||0});
      thickI.addEventListener("change",()=>{product.thickness=toPosFloat(thickI.value,0); thickI.value=product.thickness; log(`Thickness "${product.name}" in "${area.name}" â†’ ${product.thickness} mm`); updateCalculations();});
      tr.appendChild(td(thickI));

      const densI=el("input",{type:"number",min:"0",step:"0.01",value:(product.density??"")}); densI.placeholder=t("density");
      tr.appendChild(td(densI));

      const packI=el("input",{type:"number",min:"0.0001",step:"0.1",value:product.packSize||1});
      packI.addEventListener("change",()=>{product.packSize=Math.max(0.0001,parseFloat(packI.value)||1); packI.value=product.packSize; log(`Pack size "${product.name}" â†’ ${product.packSize} ${product.packUnit}`); updateCalculations();});
      tr.appendChild(td(packI));

      const unitSel=el("select"); ["kg","L"].forEach(u=>{const o=el("option",{value:u});o.textContent=u; unitSel.appendChild(o);}); unitSel.value=product.packUnit||"kg";
      tr.appendChild(td(unitSel));

      const priceI=el("input",{type:"number",min:"0",step:"0.01",value:product.price||0});
      priceI.addEventListener("change",()=>{product.price=toPosFloat(priceI.value,0); priceI.value=product.price.toFixed(2); log(`Price/pack "${product.name}" â†’ ${product.price}`); updateCalculations();});
      tr.appendChild(td(priceI));

      const needSpan=el("span",{class:"neededQty"},"0"); tr.appendChild(td(needSpan));
      const pkgSpan=el("span",{class:"packageCount"},"0"); tr.appendChild(td(pkgSpan));
      const costSpan=el("span",{class:"cost"},"0"); tr.appendChild(td(costSpan));

      // OVERLAY ACTIONS (top-right, not affecting height)
      const overlay=el("div",{class:"row-actions-overlay"});
      const cloneAll=el("button",{class:"mini ghost","data-i18n":"cloneAll"},t("cloneAll"));
      const cloneBelow=el("button",{class:"mini ghost","data-i18n":"cloneBelow"},t("cloneBelow"));
      const infoBtn=el("button",{class:"mini warn","data-i18n":"breakdown"},t("breakdown"));
      const delBtn=el("button",{class:"mini danger","data-i18n":"remove"},t("remove"));
      overlay.appendChild(cloneAll); overlay.appendChild(cloneBelow); overlay.appendChild(infoBtn); overlay.appendChild(delBtn);
      tr.appendChild(overlay);

      // breakdown row (kept for step-mode)
      const br=document.createElement("tr"); br.className="breakdown";
      const brtd=document.createElement("td"); brtd.colSpan=15; br.appendChild(brtd);
      const brbox=el("div",{class:"breakdown"}); brtd.appendChild(brbox);

      // Bind mode UI visibility
      function bindModeUI(){
        const M=product.calcMode;
        const isUsage=(M==="usage"), isThick=(M==="thickness"), isCover=(M==="coverage");
        usageI.disabled=!isUsage;
        thickI.disabled=!isThick;
        densI.disabled= (M!=="thickness") || (unitSel.value==="L");
        coverSqmI.disabled=!isCover; coverLayersI.disabled=!isCover;
      }
      bindModeUI();

      // events
      const applyCalc=()=>updateCalculations();
      mode.addEventListener("change",()=>{product.calcMode=mode.value; bindModeUI(); log(`Mode "${product.name}" â†’ ${product.calcMode}`); updateCalculations(true);});
      usageI.addEventListener("change",()=>{product.usagePerM2=toPosFloat(usageI.value,0); usageI.value=product.usagePerM2; state.lastAddedProductTemplate=cloneProductData(product); applyCalc();});
      densI.addEventListener("change",()=>{const v=toPosFloat(densI.value,0); product.density=(densI.value===""?null:v); applyCalc();});
      unitSel.addEventListener("change",()=>{product.packUnit=unitSel.value; bindModeUI(); log(`Unit "${product.name}" â†’ ${product.packUnit}`); applyCalc();});
      coverSqmI.addEventListener("change",()=>{product.coverSqmPerPack=toPosFloat(coverSqmI.value,0); applyCalc();});
      coverLayersI.addEventListener("change",()=>{product.coverLayersPerPack=Math.max(1,parseInt(coverLayersI.value)||1); coverLayersI.value=product.coverLayersPerPack; applyCalc();});

      delBtn.addEventListener("click",()=>removeProduct(area,product.id));
      cloneAll.addEventListener("click",()=>{
        pushStateForUndo(`Clone "${product.name}" to all areas`);
        state.project.areas.forEach(a=>{ if(a.id!==area.id){const c=cloneProductData(product); c.id=state.nextProductId++; a.products.push(c);} });
        log(`Cloned "${product.name}" to all areas`); renderAll();
      });
      cloneBelow.addEventListener("click",()=>{
        pushStateForUndo(`Clone "${product.name}" to areas below`);
        const idxA=state.project.areas.findIndex(a=>a.id===area.id);
        state.project.areas.slice(idxA+1).forEach(a=>{const c=cloneProductData(product); c.id=state.nextProductId++; a.products.push(c);});
        log(`Cloned "${product.name}" to areas below`); renderAll();
      });
      infoBtn.addEventListener("click",()=>{
        state.project.settings.stepMode=!state.project.settings.stepMode;
        stepModeToggle.checked=state.project.settings.stepMode;
        document.body.classList.toggle("step-on",state.project.settings.stepMode); updateCalculations(true);
      });

      const frag=document.createDocumentFragment();
      frag.appendChild(tr); frag.appendChild(br);
      return frag;
    }

    function addProduct(area,tbody){
      const p={id:state.nextProductId++,name:"",layers:1,thickness:0,density:null,packSize:1,packUnit:"kg",price:0,
        calcMode:"thickness",usagePerM2:0,coverSqmPerPack:0,coverLayersPerPack:1};
      area.products.push(p);
      const frag=buildProductRow(area,p);
      tbody.appendChild(frag);
      log(`Added product in "${area.name}" (ID ${p.id})`);
      pushStateForUndo(`Added product in area ${area.name}`);
      updateCalculations();
      return frag;
    }
    function applyProductDataToRow(area,frag,data){
      const prod=area.products[area.products.length-1];
      Object.assign(prod, cloneProductData(data));
      const areaEl=areasContainer.querySelector(`.area[data-area-id="${area.id}"]`);
      if(areaEl){ areaEl.replaceWith(createAreaElement(area)); }
    }
    function insertAreaBelow(areaId){
      const idx=state.project.areas.findIndex(a=>a.id===areaId);
      const id=state.nextAreaId++;
      const nm=(LANG==="sv"?"OmrÃ¥de ":"Area ")+id;
      const a={id,name:nm,modifier:state.project.settings.surfaceTypes["Smooth"],size:0,products:[]};
      pushStateForUndo(`Insert area below ${areaId}`);
      state.project.areas.splice(idx+1,0,a);
      renderAll(); log(`Added area "${nm}" below`);
    }
    function removeArea(areaElem){
      const id=parseInt(areaElem.dataset.areaId);
      const idx=state.project.areas.findIndex(a=>a.id===id); if(idx===-1) return;
      const nm=state.project.areas[idx].name||`Area ${id}`;
      pushStateForUndo(`Removed area ${nm}`); state.project.areas.splice(idx,1);
      areaElem.remove(); log(`Removed area "${nm}"`); updateCalculations(true);
    }
    function removeProduct(area,prodId){
      const i=area.products.findIndex(p=>p.id===prodId); if(i===-1) return;
      const nm=area.products[i].name||"(unnamed)";
      area.products.splice(i,1);
      const areaEl=areasContainer.querySelector(`.area[data-area-id="${area.id}"]`);
      if(areaEl){ areaEl.querySelectorAll(`tr.product-row[data-product-id="${prodId}"], tr.breakdown`).forEach(r=>r.remove()); }
      log(`Removed product "${nm}" from "${area.name}"`); pushStateForUndo(`Removed product from area ${area.name}`); updateCalculations(true);
    }

    /* ================== DRAG SORT ================== */
    function enableDragSort(tbody, area){
      let dragId=null;
      tbody.addEventListener("dragstart",(e)=>{
        const row=e.target.closest(".product-row"); if(!row) return;
        dragId = parseInt(row.getAttribute("data-product-id"));
        row.classList.add("dragging");
        e.dataTransfer.effectAllowed="move";
      });
      tbody.addEventListener("dragend",(e)=>{
        const row=e.target.closest(".product-row"); if(row) row.classList.remove("dragging");
      });
      tbody.addEventListener("dragover",(e)=>{
        e.preventDefault();
        const after = getDragAfterElement(tbody,e.clientY);
        const dragging=tbody.querySelector(".product-row.dragging");
        if(!dragging) return;
        if(after==null) tbody.appendChild(dragging);
        else tbody.insertBefore(dragging,after);
      });
      tbody.addEventListener("drop",()=>{
        if(dragId==null) return;
        const order=[...tbody.querySelectorAll(".product-row")].map(r=>parseInt(r.getAttribute("data-product-id")));
        const newProducts = order.map(id=> area.products.find(p=>p.id===id) );
        if(newProducts.every(Boolean)){
          pushStateForUndo(`Reorder products in ${area.name}`);
          area.products = newProducts;
          renderAll();
          log(`Reordered products in "${area.name}"`);
        }
        dragId=null;
      });
    }
    function getDragAfterElement(container, y){
      const els=[...container.querySelectorAll(".product-row:not(.dragging)")];
      return els.reduce((closest,child)=>{
        const box=child.getBoundingClientRect();
        const offset=y - box.top - box.height/2;
        if(offset<0 && offset>closest.offset){ return {offset,element:child}; } else { return closest; }
      },{offset:Number.NEGATIVE_INFINITY}).element;
    }

    /* ================== CALCULATIONS ================== */
    function refreshSummaryLabel(){
      const S=state.project.settings;
      projectSummaryEl.textContent = S.vatIncluded
        ? (LANG==="sv" ? "Projektets totalsumma (inkl. moms): " : "Project total (incl. VAT): ")
        : (LANG==="sv" ? "Projektets totalsumma (exkl. moms): " : "Project total (excl. VAT): ");
    }

    function updateCalculations(fromSurface=false){
      const S=state.project.settings;
      let totalCostExVAT=0;
      const totalsMap=new Map(); // key: name|unit -> aggregate

      state.project.areas.forEach(area=>{
        let areaCost=0;
        const areaEl=areasContainer.querySelector(`.area[data-area-id="${area.id}"]`);
        const rows = areaEl ? areaEl.querySelectorAll("tbody tr.product-row"): [];

        area.products.forEach((p,idx)=>{
          const areaSize=Number(area.size)||0;
          const layers = Math.max(1, Number(p.layers)||1);
          const unit   = p.packUnit||"kg";
          const price  = Number(p.price)||0;
          const pack   = Math.max(0.0001, Number(p.packSize)||0);

          let neededUnits=0;  // in kg or L
          let packages=0;
          let breakdown=[];

          if(p.calcMode==="usage"){
            const use=Number(p.usagePerM2)||0; // kg/L per mÂ² per layer
            let base= areaSize * layers * use;
            breakdown.push(`Base = Area(${areaSize}) Ã— Layers(${layers}) Ã— Usage(${use}/${unit}Â·mÂ²) = ${fmt(base)}`);
            base *= area.modifier; breakdown.push(`Ã— Surface ${area.modifier} â‡’ ${fmt(base)}`);
            if(S.overageIncluded){base*= (1+S.overagePercent/100); breakdown.push(`+ Overage ${S.overagePercent}% â‡’ ${fmt(base)}`);}
            neededUnits = base;
            packages = S.exactMode ? (neededUnits/pack) : Math.ceil(neededUnits/pack);

          }else if(p.calcMode==="thickness"){
            const th=Number(p.thickness)||0; let volL = areaSize * th * layers; // L
            breakdown.push(`Volume L = Area(${areaSize}) Ã— Thickness(${th}) Ã— Layers(${layers}) = ${fmt(volL)} L`);
            volL *= area.modifier; breakdown.push(`Ã— Surface ${area.modifier} â‡’ ${fmt(volL)} L`);
            if(S.overageIncluded){volL*= (1+S.overagePercent/100); breakdown.push(`+ Overage ${S.overagePercent}% â‡’ ${fmt(volL)} L`);}
            if(unit==="kg"){
              const dens = Number(p.density)||0;
              if(dens>0){ neededUnits = volL * dens; breakdown.push(`Needed kg = ${fmt(volL)} Ã— ${dens} = ${fmt(neededUnits)} kg`); }
              else { neededUnits=0; breakdown.push(`Density missing â‡’ 0 kg`); }
            }else{ neededUnits = volL; breakdown.push(`Needed L = ${fmt(neededUnits)} L`); }
            packages = S.exactMode ? (neededUnits/pack) : Math.ceil(neededUnits/pack);

          }else{ // coverage
            const cov=Number(p.coverSqmPerPack)||0; const covLayers=Math.max(1,Number(p.coverLayersPerPack)||1);
            const packsNeeded = cov>0 ? (areaSize * (layers/covLayers) / cov) : 0;
            packages = S.exactMode ? packsNeeded : Math.ceil(packsNeeded);
            neededUnits = packages * pack;
            breakdown.push(`Packs = Area(${areaSize}) Ã— (Layers ${layers}/${covLayers}) Ã· ${cov} = ${fmt(packsNeeded)} ${S.exactMode?"(exact)":""}`);
            breakdown.push(`Units = Packs Ã— PackSize = ${fmt(packages)} Ã— ${pack} = ${fmt(neededUnits)} ${unit}`);
          }

          const cost = (packages * price); areaCost += cost;

          // update UI row
          const prodRow = rows[idx];
          if(prodRow){
            const needSpan=prodRow.querySelector(".neededQty");
            const pkgSpan =prodRow.querySelector(".packageCount");
            const costSpan=prodRow.querySelector(".cost");
            if(needSpan) needSpan.textContent = neededUnits ? `${fmt(neededUnits)} ${unit}` : "0";
            if(pkgSpan)  pkgSpan.textContent  = S.exactMode ? fmt(packages) : String(packages||0);
            if(costSpan) costSpan.textContent = cost.toFixed(2);

            // breakdown box
            const brRow=prodRow.nextElementSibling;
            if(brRow && brRow.querySelector(".breakdown")){
              const box=brRow.querySelector(".breakdown");
              box.innerHTML = `
                <div><strong>${p.name||"Product"} â€” ${p.calcMode}</strong></div>
                <div>${breakdown.join("<br/>")}</div>
                <div><strong>Cost</strong> = Packages Ã— Price = ${S.exactMode?fmt(packages):packages} Ã— ${price} = <strong>${cost.toFixed(2)}</strong></div>
              `;
              brRow.style.display = S.stepMode ? "" : "none";
            }
          }

          // aggregate totals
          const key=(p.name||"(unnamed)")+"|"+unit;
          const rec= totalsMap.get(key) || {name:(p.name||"(unnamed)"),unit,needed:0,pack:pack,price:price,exactPackages:0};
          rec.needed += neededUnits;
          rec.exactPackages += (neededUnits/pack);
          totalsMap.set(key,rec);
        });

        totalCostExVAT += areaCost;

        // canvas refresh
        const canv=areasContainer.querySelector(`.area[data-area-id="${area.id}"] canvas`);
        if(canv) drawAreaIllustration(canv,area);
      });

      // totals
      const vatIncluded=S.vatIncluded, vatRate=S.vatRate;
      const displayCost = vatIncluded ? (totalCostExVAT*(1+vatRate/100)).toFixed(2) : totalCostExVAT.toFixed(2);
      refreshSummaryLabel();
      projectSummaryEl.textContent += displayCost;

      // info summary
      renderTotalsInfo(totalsMap, S);

      if(fromSurface) { lastInfoTime.textContent = t("updated")+new Date().toLocaleTimeString(); showInfoToast(); }
    }

    function renderTotalsInfo(totalsMap, S){
      const arr=[...totalsMap.values()];
      if(!arr.length){ infoBody.innerHTML = `<em>${t("infoEmpty")}</em>`; return; }

      const parts=[];
      arr.forEach(rec=>{
        const exactPk = rec.exactPackages;
        const roundedPk = Math.ceil(exactPk);
        const recommendedPk = roundedPk + 1;
        const exactCost = exactPk * rec.price;
        const roundedCost = roundedPk * rec.price;
        const recommendedCost = recommendedPk * rec.price;

        parts.push(`
          <div class="product-total">
            <h5>${rec.name} <span class="dim">[${rec.unit}]</span></h5>
            <div>${LANG==="sv"?"Totalt behov":"Total need"}: <strong>${fmt(rec.needed)} ${rec.unit}</strong></div>
            <div>${LANG==="sv"?"FÃ¶rpackningar":"Packages"}: ${LANG==="sv"?"exakt":"exact"} ${fmt(exactPk)}, ${LANG==="sv"?"avrundat":"rounded"} ${roundedPk}, <em>${LANG==="sv"?"rekommenderat":"recommended"}</em> ${recommendedPk} (${LANG==="sv"?"ta lite extra fÃ¶r sÃ¤kerhets skull":"take a little extra for safety"})</div>
            <div>${LANG==="sv"?"TÃ¤ckning (exempel)":"Coverage (example)"}: 1 ${LANG==="sv"?"lager":"layer"} = ${fmt(rec.pack)} ${rec.unit} / ${LANG==="sv"?"fÃ¶rp":"pack"} â€¢ 2 ${LANG==="sv"?"lager":"layers"} â‰ˆ ${fmt(rec.pack/2)} ${rec.unit} â€¢ 3 ${LANG==="sv"?"lager":"layers"} â‰ˆ ${fmt(rec.pack/3)} ${rec.unit}</div>
            <div>${LANG==="sv"?"Kostnad":"Cost"}: ${LANG==="sv"?"exakt":"exact"} ${exactCost.toFixed(2)}, ${LANG==="sv"?"avrundat":"rounded"} ${roundedCost.toFixed(2)}, ${LANG==="sv"?"rekommenderat":"recommended"} ${recommendedCost.toFixed(2)}</div>
          </div>
        `);
      });
      infoBody.innerHTML = parts.join("");
    }

    /* ================== RENDER ALL ================== */
    function renderAll(){
      areasContainer.innerHTML="";
      state.project.areas.forEach(a=>areasContainer.appendChild(createAreaElement(a)));
      // toolbar state
      vatToggle.checked=state.project.settings.vatIncluded;
      vatPercentInput.value=state.project.settings.vatRate;
      overageToggle.checked=state.project.settings.overageIncluded;
      overagePercentInput.value=state.project.settings.overagePercent;
      exactToggle.checked=state.project.settings.exactMode||false;
      stepModeToggle.checked=state.project.settings.stepMode||false;
      darkModeToggle.checked=state.project.settings.darkMode||false;
      document.body.classList.toggle("step-on", state.project.settings.stepMode);
      document.body.classList.toggle("dark-mode", state.project.settings.darkMode);

      renderTemplates();
      applyI18n();
      updateCalculations(true);

      // update undo/redo titles
      const ud=state.undoStack.at(-1)?.desc || (LANG==="sv"?"Inget att Ã¥ngra":"Nothing to undo");
      const rd=state.redoStack.at(-1)?.desc || (LANG==="sv"?"Inget att gÃ¶ra om":"Nothing to redo");
      undoBtn.title = (LANG==="sv"?"Ã…ngra: ":"Undo: ")+ud;
      redoBtn.title = (LANG==="sv"?"GÃ¶r om: ":"Redo: ")+rd;
      undoBtn.disabled=state.undoStack.length===0;
      redoBtn.disabled=state.redoStack.length===0;
    }

    /* ================== TEMPLATES (bottom section) ================== */
    const TKEY="__TEMPLATES__";
    function newTemplate(){ return {id:state.nextTemplateId++,name:"",calcMode:"thickness",usagePerM2:0,layers:1,thickness:0,density:null,packSize:1,packUnit:"kg",price:0,coverSqmPerPack:0,coverLayersPerPack:1}; }
    function getTemplates(){ if(!state._templates) state._templates=[]; return state._templates; }
    function saveTemplates(){ localStorage.setItem(TKEY, JSON.stringify(getTemplates())); }
    function loadTemplates(){ try{ const raw=localStorage.getItem(TKEY); if(raw){const arr=JSON.parse(raw)||[]; state._templates=arr; state.nextTemplateId=(Math.max(0,...arr.map(x=>x.id||0))+1)||1;}}catch{state._templates=[];} }
    function renderTemplates(){
      templatesBody.innerHTML="";
      const list=getTemplates();
      if(!list.length){ templatesBody.innerHTML=`<div style="color:var(--muted)">${LANG==="sv"?"Inga mallar Ã¤nnu.":"No templates yet."}</div>`; return; }
      list.forEach(t=>{
        const row=el("div",{style:"display:grid;grid-template-columns: 200px 140px 150px 90px 110px 110px 110px 90px 120px 120px 120px auto;gap:8px;align-items:center;margin:6px 0"});
        const n=el("input",{value:t.name,placeholder:t("product")}); row.appendChild(n);
        const mode=el("select"); [["thickness",t("calcThickness")],["usage",t("calcUsage")],["coverage",t("calcCoverage")]].forEach(([v,l])=>{const o=el("option",{value:v});o.textContent=l;mode.appendChild(o);}); mode.value=t.calcMode; row.appendChild(mode);
        const use=el("input",{type:"number",min:"0",step:"0.001",value:t.usagePerM2||0}); row.appendChild(use);
        const lay=el("input",{type:"number",min:"1",step:"1",value:t.layers||1}); row.appendChild(lay);
        const th =el("input",{type:"number",min:"0",step:"0.1",value:t.thickness||0}); row.appendChild(th);
        const de =el("input",{type:"number",min:"0",step:"0.01",value:(t.density??"")}); row.appendChild(de);
        const ps =el("input",{type:"number",min:"0.0001",step:"0.1",value:t.packSize||1}); row.appendChild(ps);
        const pu =el("select"); ["kg","L"].forEach(u=>{const o=el("option",{value:u});o.textContent=u; pu.appendChild(o);}); pu.value=t.packUnit||"kg"; row.appendChild(pu);
        const pr =el("input",{type:"number",min:"0",step:"0.01",value:t.price||0}); row.appendChild(pr);
        const coverS =el("input",{type:"number",min:"0",step:"0.1",value:t.coverSqmPerPack||0,placeholder:t("coverSqm")}); row.appendChild(coverS);
        const coverL =el("input",{type:"number",min:"1",step:"1",value:t.coverLayersPerPack||1,placeholder:t("coverLayers")}); row.appendChild(coverL);

        const actions=el("div",{style:"display:flex;gap:8px;justify-content:flex-end"});
        const applyAll=el("button",{class:"btn btn-ghost"} , t("applyAllTemplates"));
        const del=el("button",{class:"btn btn-ghost",style:"border:1px solid var(--line)"},"Delete");
        actions.appendChild(applyAll); actions.appendChild(del);
        row.appendChild(actions);

        const bind=()=>{ t.name=n.value; t.calcMode=mode.value; t.usagePerM2=toPosFloat(use.value,0); t.layers=Math.max(1,parseInt(lay.value)||1); t.thickness=toPosFloat(th.value,0);
          t.density=(de.value===""?null:toPosFloat(de.value,0)); t.packSize=Math.max(0.0001,parseFloat(ps.value)||1); t.packUnit=pu.value; t.price=toPosFloat(pr.value,0);
          t.coverSqmPerPack=toPosFloat(coverS.value,0); t.coverLayersPerPack=Math.max(1,parseInt(coverL.value)||1);
        };
        [n,mode,use,lay,th,de,ps,pu,pr,coverS,coverL].forEach(inp=>inp.addEventListener("change",()=>{bind();saveTemplates();}));

        applyAll.addEventListener("click",()=>{
          bind(); saveTemplates();
          pushStateForUndo(`Apply template "${t.name}" to all areas`);
          state.project.areas.forEach(a=>{const np=cloneProductData(t); np.id=state.nextProductId++; a.products.push(np);});
          log(t("tmplApplyAll")); renderAll();
        });
        del.addEventListener("click",()=>{
          if(!confirm(LANG==="sv"?"Ta bort mallen?":"Delete this template?")) return;
          const L=getTemplates(); const idx=L.findIndex(x=>x.id===t.id); if(idx>-1){L.splice(idx,1); saveTemplates(); renderTemplates();}
        });

        templatesBody.appendChild(row);
      });
    }

    /* ================== IMPORT / EXPORT ================== */
    function importData(file,content){
      const name=file.name;
      if(name.endsWith(".json")){
        try{
          const parsed=JSON.parse(content);
          if(!parsed.areas||!parsed.settings) throw new Error("Invalid JSON format");
          pushStateForUndo(`Imported JSON (${name})`);
          state.project.areas=parsed.areas; state.project.settings={...state.project.settings,...parsed.settings};
          state.nextAreaId=1; state.nextProductId=1; state.project.areas.forEach(a=>{if(a.id>=state.nextAreaId)state.nextAreaId=a.id+1;a.products.forEach(p=>{if(p.id>=state.nextProductId)state.nextProductId=p.id+1;});});
          renderAll(); log(`Imported JSON "${name}"`);
        }catch(err){ alert("Failed to import JSON: "+err.message); log("Error importing JSON: "+err.message); }
      }else if(name.endsWith(".csv")){
        try{
          const lines=content.split(/\r?\n/).filter(l=>l.trim().length>0); if(!lines.length) throw new Error("Empty CSV");
          let start=0, headers=[]; if(/area\s*name|areaname/i.test(lines[0])){headers=parseCSVLine(lines[0]);start=1;} else headers=["AreaName","SurfaceType","SurfaceMod","AreaSize","ProductName","Layers","Thickness","Density","PackSize","PackUnit","Price","VATIncluded","VATRate","OverageIncluded","OveragePercent"];
          const idx={}; headers.forEach((c,i)=>idx[c]=i);
          const importedAreas=[]; const map={}; let importedSettings={};
          for(let i=start;i<lines.length;i++){
            const v=parseCSVLine(lines[i]); if(!v.length) continue;
            const aName=v[idx["AreaName"]??0]||""; if(!aName) continue;
            const sType=v[idx["SurfaceType"]]||"Custom";
            const sMod =parseFloat(v[idx["SurfaceMod"]])||1.0;
            const aSize=parseFloat(v[idx["AreaSize"]])||0;
            const pName=v[idx["ProductName"]]||"";
            const layers=parseInt(v[idx["Layers"]])||1;
            const thick =parseFloat(v[idx["Thickness"]])||0;
            const dens =(v[idx["Density"]]!=="" && v[idx["Density"]]!=null)? parseFloat(v[idx["Density"]]): null;
            const pSize =parseFloat(v[idx["PackSize"]])||1;
            const pUnit =v[idx["PackUnit"]]||"kg";
            const price =parseFloat(v[idx["Price"]])||0;
            if(i===start){
              importedSettings.vatIncluded = /^(true|1)$/i.test(v[idx["VATIncluded"]]||"");
              importedSettings.vatRate     = parseFloat(v[idx["VATRate"]]) || state.project.settings.vatRate;
              importedSettings.overageIncluded = /^(true|1)$/i.test(v[idx["OverageIncluded"]]||"");
              importedSettings.overagePercent  = parseFloat(v[idx["OveragePercent"]]) || state.project.settings.overagePercent;
            }
            let area = map[aName];
            if(!area){ area={id:state.nextAreaId++,name:aName,modifier:sMod,size:aSize,products:[]}; map[aName]=area; importedAreas.push(area); }
            if(pName || price>0 || thick>0){
              area.products.push({
                id:state.nextProductId++, name:pName, layers, thickness:thick, density:dens, packSize:pSize, packUnit:pUnit, price,
                calcMode:"thickness", usagePerM2:0, coverSqmPerPack:0, coverLayersPerPack:1
              });
            }
          }
          pushStateForUndo(`Imported CSV (${name})`);
          state.project.areas=importedAreas; state.project.settings={...state.project.settings,...importedSettings}; renderAll(); log(`Imported CSV "${name}"`);
        }catch(err){ alert("Failed to import CSV: "+err.message); log("Error importing CSV: "+err.message); }
      }else{ alert(t("errUnsupported")); log("Import failed: unsupported file"); }
    }
    function parseCSVLine(line){
      const out=[]; let cur=""; let q=false;
      for(let i=0;i<line.length;i++){
        const ch=line[i];
        if(!q){ if(ch===','){out.push(cur.trim());cur="";} else if(ch==='"'){q=true;} else cur+=ch; }
        else{ if(ch==='"'){ if(i+1<line.length && line[i+1]==='"'){cur+='"'; i++;} else q=false; } else cur+=ch; }
      }
      out.push(cur.trim()); return out;
    }
    function exportJSON(){ const blob=new Blob([JSON.stringify(state.project,null,2)],{type:"application/json"}); downloadBlob(blob,"project_export.json"); log("Exported JSON"); }
    function exportCSV(){
      const headers=["AreaName","SurfaceType","SurfaceMod","AreaSize","ProductName","Layers","Thickness","Density","PackSize","PackUnit","Price","VATIncluded","VATRate","OverageIncluded","OveragePercent"];
      const lines=[headers.join(",")]; const S=state.project.settings;
      state.project.areas.forEach(a=>{
        if(!a.products.length){
          lines.push([a.name, reverseFindTypeByFactor(a.modifier)||"Custom", a.modifier, a.size,"","","","","","","",S.vatIncluded,S.vatRate,S.overageIncluded,S.overagePercent].map(formatCSVValue).join(","));
        }else{
          a.products.forEach(p=>{
            lines.push([a.name, reverseFindTypeByFactor(a.modifier)||"Custom", a.modifier, a.size, p.name||"", p.layers, p.thickness, (p.density!=null?p.density:""), p.packSize, p.packUnit, p.price, S.vatIncluded,S.vatRate,S.overageIncluded,S.overagePercent].map(formatCSVValue).join(","));
          });
        }
      });
      downloadBlob(new Blob([lines.join("\n")],{type:"text/csv"}),"project_export.csv"); log("Exported CSV");
    }
    function generateExcelXML(){
      const nl="\r\n";
      let xml='<?xml version="1.0"?>'+nl;
      xml+='<?mso-application progid="Excel.Sheet"?>'+nl;
      xml+='<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet" xmlns:html="http://www.w3.org/TR/REC-html40">'+nl;
      xml+='<Styles>'+nl+'<Style ss:ID="Bold"><Font ss:Bold="1"/></Style>'+nl+'<Style ss:ID="TwoDec"><NumberFormat ss:Format="0.00"/></Style>'+nl+'<Style ss:ID="BoldTwoDec"><Font ss:Bold="1"/><NumberFormat ss:Format="0.00"/></Style>'+nl+'</Styles>'+nl;
      xml+='<Worksheet ss:Name="Estimate">'+nl;
      const COLS=16; let rows=1; state.project.areas.forEach(a=>{rows+=a.products.length; rows+=1;}); rows+=1;
      xml+=`<Table ss:ExpandedColumnCount="${COLS}" ss:ExpandedRowCount="${rows}">`+nl;
      for(let j=0;j<COLS;j++){xml+='<Column ss:AutoFitWidth="1"/>'+nl;}
      const headers=["Area","Surface Mod","Area Size (mÂ²)","Product","Mode","Usage/mÂ²","Cover mÂ²/pack","Cover layers/pack","Layers","Thickness (mm)","Density (kg/L)","Pack size","Unit","Price/Pack","Needed","Packages","Cost"];
      xml+='<Row ss:StyleID="Bold">'+nl; headers.forEach(h=>xml+=`<Cell><Data ss:Type="String">${h}</Data></Cell>`+nl); xml+='</Row>'+nl;

      let rowIndex=1, areaTotalRows=[];
      state.project.areas.forEach(a=>{
        a.products.forEach(p=>{
          rowIndex++;
          const S=state.project.settings;
          const areaSize=Number(a.size)||0, layers=Math.max(1,Number(p.layers)||1);
          const unit=p.packUnit||"kg", price=Number(p.price)||0, packSize=Math.max(0.0001,Number(p.packSize)||0);
          let needed=0, packages=0;
          if((p.calcMode||"thickness")==="usage"){
            let base= areaSize*layers*(Number(p.usagePerM2)||0); base*=a.modifier; if(S.overageIncluded) base*=(1+S.overagePercent/100);
            needed=base; packages= S.exactMode ? needed/packSize : Math.ceil(needed/packSize);
          }else if(p.calcMode==="thickness"){
            let volL= areaSize*(Number(p.thickness)||0)*layers; volL*=a.modifier; if(S.overageIncluded) volL*=(1+S.overagePercent/100);
            needed = (unit==="kg") ? ((Number(p.density)||0)>0 ? volL*(Number(p.density)||0) : 0) : volL;
            packages= S.exactMode ? needed/packSize : Math.ceil(needed/packSize);
          }else{
            const cov=Number(p.coverSqmPerPack)||0; const covL=Math.max(1,Number(p.coverLayersPerPack)||1);
            const packNeed = cov>0 ? (areaSize * (layers/covL) / cov) : 0;
            packages = S.exactMode ? packNeed : Math.ceil(packNeed);
            needed = packages * packSize;
          }
          const cost=packages*price;
          xml+='<Row>'+nl;
          xml+=`<Cell><Data ss:Type="String">${escapeXML(a.name)}</Data></Cell>`+nl;
          xml+=`<Cell><Data ss:Type="Number">${a.modifier}</Data></Cell>`+nl;
          xml+=`<Cell><Data ss:Type="Number">${a.size}</Data></Cell>`+nl;
          xml+=`<Cell><Data ss:Type="String">${escapeXML(p.name||"")}</Data></Cell>`+nl;
          xml+=`<Cell><Data ss:Type="String">${p.calcMode}</Data></Cell>`+nl;
          xml+=`<Cell><Data ss:Type="Number">${p.usagePerM2||0}</Data></Cell>`+nl;
          xml+=`<Cell><Data ss:Type="Number">${p.coverSqmPerPack||0}</Data></Cell>`+nl;
          xml+=`<Cell><Data ss:Type="Number">${p.coverLayersPerPack||1}</Data></Cell>`+nl;
          xml+=`<Cell><Data ss:Type="Number">${layers}</Data></Cell>`+nl;
          xml+=`<Cell><Data ss:Type="Number">${p.thickness||0}</Data></Cell>`+nl;
          xml+=`<Cell><Data ss:Type="Number">${(p.density!=null?p.density:"")}</Data></Cell>`+nl;
          xml+=`<Cell><Data ss:Type="Number">${p.packSize||0}</Data></Cell>`+nl;
          xml+=`<Cell><Data ss:Type="String">${unit}</Data></Cell>`+nl;
          xml+=`<Cell><Data ss:Type="Number">${price}</Data></Cell>`+nl;
          xml+=`<Cell><Data ss:Type="Number">${needed.toFixed(1)}</Data></Cell>`+nl;
          xml+=`<Cell><Data ss:Type="Number">${S.exactMode?fmt(packages):packages}</Data></Cell>`+nl;
          xml+=`<Cell ss:StyleID="TwoDec"><Data ss:Type="Number">${cost.toFixed(2)}</Data></Cell>`+nl;
          xml+='</Row>'+nl;
        });
        rowIndex++; areaTotalRows.push(rowIndex);
        let areaTotal=0;
        a.products.forEach(p=>{
          const S=state.project.settings; const areaSize=Number(a.size)||0; const layers=Math.max(1,Number(p.layers)||1);
          const unit=p.packUnit||"kg"; const price=Number(p.price)||0; const packSize=Math.max(0.0001,Number(p.packSize)||0);
          let needed=0, packages=0;
          if((p.calcMode||"thickness")==="usage"){
            let base= areaSize*layers*(Number(p.usagePerM2)||0); base*=a.modifier; if(S.overageIncluded) base*=(1+S.overagePercent/100);
            needed=base; packages= S.exactMode ? needed/packSize : Math.ceil(needed/packSize);
          }else if(p.calcMode==="thickness"){
            let volL= areaSize*(Number(p.thickness)||0)*layers; volL*=a.modifier; if(S.overageIncluded) volL*=(1+S.overagePercent/100);
            needed = (unit==="kg") ? ((Number(p.density)||0)>0 ? volL*(Number(p.density)||0) : 0) : volL;
            packages= S.exactMode ? needed/packSize : Math.ceil(needed/packSize);
          }else{
            const cov=Number(p.coverSqmPerPack)||0; const covL=Math.max(1,Number(p.coverLayersPerPack)||1);
            const packNeed = cov>0 ? (areaSize * (layers/covL) / cov) : 0;
            packages = S.exactMode ? packNeed : Math.ceil(packNeed);
            needed = packages * packSize;
          }
          areaTotal += packages*price;
        });
        xml+='<Row ss:StyleID="Bold">'+nl;
        xml+=`<Cell ss:MergeAcross="14"><Data ss:Type="String">${escapeXML(a.name)} Total</Data></Cell>`+nl;
        xml+=`<Cell ss:StyleID="BoldTwoDec"><Data ss:Type="Number">${areaTotal.toFixed(2)}</Data></Cell>`+nl;
        xml+='</Row>'+nl;
      });
      rowIndex++;
      xml+='<Row ss:StyleID="Bold">'+nl;
      xml+='<Cell ss:MergeAcross="14"><Data ss:Type="String">Project Total</Data></Cell>'+nl;
      if(areaTotalRows.length){ const refs=areaTotalRows.map(r=>`R${r}C`); xml+=`<Cell ss:StyleID="BoldTwoDec" ss:Formula="=SUM(${refs.join(",")})"><Data ss:Type="Number"></Data></Cell>`+nl; }
      else xml+='<Cell ss:StyleID="BoldTwoDec"><Data ss:Type="Number">0</Data></Cell>'+nl;
      xml+='</Row>'+nl + '</Table>'+nl + '</Worksheet>'+nl + '</Workbook>';
      return xml;
    }
    function exportExcel(){ downloadBlob(new Blob([generateExcelXML()],{type:"application/vnd.ms-excel"}),"project_estimate.xls"); log("Exported Excel"); }

    /* ================== EVENTS ================== */
    btnAddAreaTop.addEventListener("click",()=>{
      const id=state.nextAreaId++; const nm=(LANG==="sv"?"OmrÃ¥de ":"Area ")+id;
      const a={id,name:nm,modifier:state.project.settings.surfaceTypes["Smooth"],size:0,products:[]};
      state.project.areas.push(a); const el=createAreaElement(a); areasContainer.appendChild(el);
      log(`Added area "${nm}"`); pushStateForUndo(`Added area ${nm}`); updateCalculations();
    });
    undoBtn.addEventListener("click",undo); redoBtn.addEventListener("click",redo);

    vatToggle.addEventListener("change",()=>{state.project.settings.vatIncluded=vatToggle.checked; log(`VAT ${vatToggle.checked?"included":"excluded"}`); updateCalculations();});
    vatPercentInput.addEventListener("change",()=>{state.project.settings.vatRate=toPosFloat(vatPercentInput.value,0); log(`VAT ${state.project.settings.vatRate}%`); updateCalculations();});
    overageToggle.addEventListener("change",()=>{state.project.settings.overageIncluded=overageToggle.checked; log(`${overageToggle.checked?"Apply":"Remove"} overage`); updateCalculations();});
    overagePercentInput.addEventListener("change",()=>{state.project.settings.overagePercent=toPosFloat(overagePercentInput.value,0); if(state.project.settings.overageIncluded) updateCalculations();});
    exactToggle.addEventListener("change",()=>{state.project.settings.exactMode=exactToggle.checked; log(`Exact mode ${state.project.settings.exactMode?"ON":"OFF"}`); updateCalculations();});
    darkModeToggle.addEventListener("change",()=>{state.project.settings.darkMode=darkModeToggle.checked; document.body.classList.toggle("dark-mode", state.project.settings.darkMode);});
    stepModeToggle.addEventListener("change",()=>{state.project.settings.stepMode=stepModeToggle.checked; document.body.classList.toggle("step-on", state.project.settings.stepMode); updateCalculations();});

    importBtn.addEventListener("click",()=>fileInput.click());
    fileInput.addEventListener("change",(e)=>{
      const file=e.target.files[0]; if(!file) return; const r=new FileReader();
      r.onload=()=>importData(file,r.result); r.onerror=()=>{alert("Failed to read file"); log("Error reading file");}; r.readAsText(file); fileInput.value="";
    });
    exportJSONBtn.addEventListener("click",exportJSON);
    exportCSVBtn.addEventListener("click",exportCSV);
    exportExcelBtn.addEventListener("click",exportExcel);
    printBtn.addEventListener("click",()=>{window.print(); log("Print/PDF");});

    minimizeLogBtn.addEventListener("click",()=>{if(!logPanel.classList.contains("minimized")) logPanel.classList.add("minimized"); else {logPanel.classList.remove("minimized"); logPanel.classList.remove("maximized");}});
    maximizeLogBtn.addEventListener("click",()=>{if(logPanel.classList.contains("maximized")) logPanel.classList.remove("maximized"); else {logPanel.classList.remove("minimized"); logPanel.classList.add("maximized");}});

    infoToast.addEventListener("click",()=>{document.getElementById("infoSummary").scrollIntoView({behavior:"smooth"}); infoToast.style.display="none";});

    // Language toggles
    langSV.addEventListener("click",()=>{LANG="sv"; langSV.classList.add("active"); langEN.classList.remove("active"); applyI18n(); renderAll();});
    langEN.addEventListener("click",()=>{LANG="en"; langEN.classList.add("active"); langSV.classList.remove("active"); applyI18n(); renderAll();});

    // Templates buttons (ensure works & at bottom)
    addTemplateBtn.addEventListener("click",()=>{
      const tmpl=newTemplate(); const L=getTemplates(); L.push(tmpl); saveTemplates(); renderTemplates(); log(t("tmplAdded"));
    });
    applyAllTemplatesBtn.addEventListener("click",()=>{
      const L=getTemplates(); if(!L.length) return;
      pushStateForUndo("Apply ALL templates to ALL areas");
      state.project.areas.forEach(a=>{
        L.forEach(tpl=>{const np=cloneProductData(tpl); np.id=state.nextProductId++; a.products.push(np);});
      });
      log(t("tmplApplyAll")); renderAll();
    });

    /* ================== INIT ================== */
    loadTemplates();
    log("App started");
    applyI18n();
    renderAll();

  })();
  </script>
</body>
</html>
